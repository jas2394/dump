<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<title>JavaScript: The Complete Reference&#153;, Third Edition</title>
<link href="0071741216.css" rel="stylesheet" type="text/css"/>
<link href="page-template.xpgt" rel="stylesheet" type="application/vnd.adobe-page-template+xml"/>
<meta content="urn:uuid:4d1be0af-c0d3-47b8-9bd4-3edcb4dee196" name="Adept.expected.resource"/>
</head>
<body>
<h3 class="h3b" id="ch17"><a id="page_771"/><strong>CHAPTER 17<br/>Media Management</strong></h3>
<p class="noindent">Web pages are not composed solely of text, but generally include a variety of dependent media items such as images (static and generated), videos, audio clips, and multimedia elements such as Flash files. In this chapter, we explore how JavaScript can be used to add and manipulate media elements. Our focus as a reference is primarily on syntax, though we do present a number of illustrative examples, both to present syntax in context and to illuminate common challenges that JavaScript programmers may face.</p>
<h4 class="h4"><a id="ch17lev1sec1"/><strong>Image Handling</strong></h4>
<p class="noindent">The <span class="codesample">images[]</span> collection of the <span class="codesample">Document</span> object contains <span class="codesample">Image</span> objects (known as <span class="codesample">HTMLImageElement</span> in the DOM1 specification) corresponding to all of the <span class="codesample"><strong>&lt;img&gt;</strong></span> tags in the document. Like all collections, images can be referenced numerically (<span class="codesample">document.images[2]</span>), associatively (<span class="codesample">document.images[“<em>imagename</em> ”]</span>), and directly (<span class="codesample">document.images.<em>imagename</em></span>), though developers may commonly employ standard DOM methods such as <span class="codesample">getElementById()</span> or <span class="codesample">getElementsByTagName()</span> to access images just as they would any other element in a DOM tree.</p>
<p class="indent">The properties of the Image object correspond, as expected, to the attributes of the <span class="codesample"><strong>&lt;img&gt;</strong></span> tag as defined by HTML5. An overview of the properties of the <span class="codesample">Image</span> object beyond the common <span class="codesample">id, className, style, title</span>, and DOM and HTML5 properties are presented in <a class="nounder" href="ch17.html#tab17-1">Table 17-1</a>.</p>
<p class="tabcap"><a id="tab17-1"/><strong>Table 17-1</strong> Properties of the Image Object</p>
<p class="imagea"><img alt="image" src="t0772-01.jpg"/></p>
<p class="image0"><img alt="image" src="t0772-02.jpg"/></p>
<p class="indent">The traditional <span class="codesample">Image</span> object supports the standard event handlers but also supports the <span class="codesample">onabort, onerror</span>, and <span class="codesample">onload</span> event handlers. The <span class="codesample">onabort</span> handler is invoked when the user aborts the loading of the image, usually by clicking the browser’s Stop button. The <span class="codesample">onerror</span> handler is fired when an error occurs during image loading. The <span class="codesample">onload</span> handler is, of course, fired once the image has loaded. Be cautious with <span class="codesample">onload</span>, as it may fire in the case of broken images as well as correctly loaded ones.</p>
<p class="indent"><a id="page_772"/>The following example illustrates simple access to the common properties of <span class="codesample">Image</span>. A rendering of the example is shown in <a class="nounder" href="ch17.html#fig17-1">Figure 17-1</a>.</p>
<p class="image1"><a id="fig17-1"/><img alt="image" src="f0774-01.jpg"/></p>
<p class="figcap"><strong>Figure 17-1</strong> Rendering of Image object tester</p>
<p class="image"><img alt="image" src="f0772-01.jpg"/></p>
<p class="image"><a id="page_773"/><img alt="image" src="f0772-02.jpg"/></p>
<p class="image0"><img alt="image" src="f0772-03.jpg"/></p>
<p class="indent"><a id="page_774"/>Notice in the preceding example how it is possible to manipulate the image <span class="codesample">src</span> dynamically. We’ll explore this a bit when we discuss the first application of the <span class="codesample">Image</span> object—the ubiquitous rollover button.</p>
<h5 class="h5"><a id="page_775"/><a id="ch17lev2sec1"/><strong>Applied Images</strong></h5>
<p class="noindent">It is probably useful to show some applications of JavaScript manipulation of images to illustrate some common techniques and to contrast older ideas with new technologies such as <span class="codesample"><strong>&lt;canvas&gt;</strong></span>, discussed in an upcoming section. We are by no means complete here in this discussion and aim to present a use case and any concerns it may reveal. Readers are encouraged to search the Web to find production-ready versions of these examples.</p>
<h6 class="h6"><strong>Rollovers</strong></h6>
<p class="noindent">Probably the most common use initially of the <span class="codesample">Image</span> object was for the ubiquitous rollover or mouseover image. Today’s developers are encouraged, in nearly all cases, to use CSS-based rollovers. However, we take a brief moment to discuss JavaScript rollovers, as the challenges and mitigating techniques introduced by this first example of Dynamic HTML (DHTML) are still with us today. To create a basic rollover button, first you will need two, perhaps even three, images to represent each of the button’s states—<em>inactive, active</em>, and <em>unavailable</em>. The first two states are for when the mouse is and is not over the button; the last is an optional state in case you wish to show the button inoperable (for example, grayed out). A simple pair of images for a rollover button is shown here:</p>
<p class="image"><img alt="image" src="f0775-01.jpg"/></p>
<p class="indent">The idea is to include the image in the page as normal with an <span class="codesample"><strong>&lt;img&gt;</strong></span> tag referencing the image in its inactive state. When the mouse passes over the image, switch the image’s <span class="codesample"><strong>src</strong></span> to the image representing its active state, and when it leaves revert back to the original image. Naively you might try this:</p>
<p class="image"><img alt="image" src="f0775-02.jpg"/></p>
<p class="noindent">Of course, you could even shorten the example since you do not need to reference the object path; instead, use the keyword <span class="codesample">this</span>, as shown here:</p>
<p class="image"><img alt="image" src="f0775-03.jpg"/></p>
<p class="noindent">This idea will work in new browsers quite easily, but initially this wouldn’t have been possible since the <span class="codesample">Image</span> object previously had no mouseover event handler and, in fact, we faced a time when the technology wasn’t ubiquitous. Initial attempts to look for image support employed browser detection:</p>
<p class="image"><img alt="image" src="f0775-04.jpg"/></p>
<p class="noindent">However, this approach suffers because it requires us to be browser feature experts in a world where features change all the time. Furthermore, we often find browsers masquerading as <a id="page_776"/>other browsers. A better way to handle this problem would be to employ some form of feature detection, for example, looking for the presence of the <span class="codesample">document.images[]</span> collection:</p>
<p class="image"><img alt="image" src="f0776-01.jpg"/></p>
<p class="noindent">If, later, we then had to deal with browser-specific issues, we would splice that in:</p>
<p class="image"><img alt="image" src="f0776-02.jpg"/></p>
<p class="noindent">However, besides the complexity of capability support and browser-specific fix-ups, we may also encounter some network issues. For example, what will happen if the user starts triggering rollovers when the rollover images haven’t been downloaded? Unfortunately, the answer is that a broken image will be shown. To combat this, we use JavaScript preloading to force the browser to download an image (or another object) before it is actually needed and put it in cache for later use. Here is one time where the blocking nature of JavaScript actually serves us well. A simple illustrative code fragment might look like this:</p>
<p class="image"><img alt="image" src="f0776-03.jpg"/></p>
<p class="noindent">Of course, more appropriately, we should employ a function to avoid repetitive code.</p>
<p class="indent">At this point, we are ready to think about generalizing the code to avoid inline event handlers and the like and to try to aim to make it easily configurable via markup. In the example here, we employ HTML5 <span class="codesample"><strong>data-*</strong></span> attributes and look over the document to find those that need rollovers bound to them:</p>
<p class="image"><img alt="image" src="f0776-04.jpg"/></p>
<p class="image"><img alt="image" src="f0776-05.jpg"/></p>
<hr/>
<p class="online"><a id="page_777"/><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/oldfashionrollovers.html">http://javascriptref.com/3ed/ch17/oldfashionrollovers.html</a></p>
<p class="indent">Of course, this isn’t really the best approach today considering that we could perform this much easier just using CSS and the : <span class="codesample">hover</span> pseudo class selector, as shown here:</p>
<p class="image"><img alt="image" src="f0777-01.jpg"/></p>
<hr/>
<p class="online"><a id="page_778"/><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/cssrollovers.html">http://javascriptref.com/3ed/ch17/cssrollovers.html</a></p>
<p class="indent">With CSS, most go even further and address the multiple image download problem that plagues rollovers. For example, we might create one large image of navigation buttons in various states. Such an image is generally dubbed a CSS sprite or sprite sheet. A simple example is shown here.</p>
<p class="image1"><img alt="image" src="f0778-01.jpg"/></p>
<p class="noindent">To utilize the sprite sheet, we would then change our hovers to reveal the position of the image we are interested in.</p>
<p class="indent">So, given that we can use CSS for rollovers, why would one ever want to use JavaScript? Simply put, JavaScript is just more flexible, and the hover can trigger anything. For example, let’s say we wanted to change the image and have some explanatory text appear elsewhere on the screen. You might aim to use the CSS <span class="codesample">content</span> property to do this, but fundamentally what you will find out is that the more interactivity you add, the more you still need JavaScript. Trying to force CSS into coding duties is going to be a lesson in frustration.</p>
<p class="indent">To encourage readers not to give up on JavaScript here, consider this example, which updates a region and modifies the rollover half using CSS and the other half using JavaScript, as shown in <a class="nounder" href="ch17.html#fig17-2">Figure 17-2</a>.</p>
<p class="image1"><a id="fig17-2"/><img alt="image" src="f0780-01.jpg"/></p>
<p class="figcap"><strong>Figure 17-2</strong> CSS and JavaScript rollovers living together</p>
<p class="image"><img alt="image" src="f0778-02.jpg"/></p>
<p class="image0"><img alt="image" src="f0778-03.jpg"/></p>
<hr/>
<p class="online"><a id="page_779"/><strong>ONLINE</strong> <a href="http://javascriptref.com/3ed/ch17.html5rollovers.html">http://javascriptref.com/3ed/ch17.html5rollovers.html</a></p>
<h6 class="h6"><a id="page_780"/><strong>Light Boxes</strong></h6>
<p class="noindent">Another common use of JavaScript and images is to create some sort of slide show or light box effect. Very often we might want to display a thumbnail and then click on it and have it show in a larger form. As an example, here we have a few images of pets, and we attach <span class="codesample">class</span> names to indicate we would like light box functionality:</p>
<p class="image"><img alt="image" src="f0780-02.jpg"/></p>
<p class="indent">When the page loads, we might find each image and associate a click event to bring up the light box:</p>
<p class="image"><img alt="image" src="f0780-03.jpg"/></p>
<p class="noindent">The light box would be created by creating a <span class="codesample"><strong>&lt;div&gt;</strong></span> tag to overlay the whole screen; for example, if we had a CSS class called <span class="codesample">blackout</span>, we could then dynamically create a <span class="codesample"><strong>&lt;div&gt;</strong></span> when the light-boxed image is clicked to cover the screen:</p>
<p class="image"><a id="page_781"/><img alt="image" src="f0781-01.jpg"/></p>
<p class="noindent">We would then add a click handler to it for dismissing the overlay once it is clicked:</p>
<p class="image"><img alt="image" src="f0781-02.jpg"/></p>
<p class="indent">Finally, we need to put the image on the overlay, probably the most difficult thing being to make sure that we center it properly:</p>
<p class="image"><img alt="image" src="f0781-03.jpg"/></p>
<p class="noindent">Once the image is added to the overlay, we then add it to the document and get the full effect shown in <a class="nounder" href="ch17.html#fig17-3">Figure 17-3</a>.</p>
<p class="image1"><a id="fig17-3"/><img alt="image" src="f0782-01.jpg"/></p>
<p class="figcap"><strong>Figure 17-3</strong> Simple lightbox in action</p>
<p class="image"><img alt="image" src="f0781-04.jpg"/></p>
<hr/>
<p class="online"><strong>ONLINE</strong> <a class="nounder" href="http://www.www.javascriptref.com/3ed/ch17/lightbox.html">http://www.javascriptref.com/3ed/ch17/lightbox.html</a></p>
<p class="indent">Clearly, there are many things we might consider adding to the light box example, including captions, more styling, and likely some dramatic sizing and show-hide mechanism to add a little drama. As we add more and more glitz to the demo, we start to see it become what is thought of as DHTML, so it is probably better that we discuss this idea more generally.</p>
<h4 class="h4"><a id="page_782"/><a id="ch17lev1sec2"/><strong>DHTML, DOMEffects, and Animation</strong></h4>
<p class="noindent">We’ve seen how JavaScript can be used to update images in the page dynamically in response to user actions. But if you consider that almost all parts of the page are scriptable in modern browsers, you’ll realize that manipulating images is only the tip of the iceberg. Given browser support, you can update not just images but also text and other content enclosed in tags, particularly <span class="codesample"><strong>&lt;div&gt;</strong></span> tags, embedded objects, forms, and even the text in the page. You’re not just limited to changing content, either. Because most objects expose their CSS properties, you can change appearance and layout as well.</p>
<p class="indent">Three technologies come together to provide these features: HTML markup provides the structural foundation of content, CSS contributes to its appearance and placement, and JavaScript enables the dynamic manipulation of both of these features. This combination of technologies is often referred to as <em>Dynamic HTML</em>, or <em>DHTML</em> for short, particularly when the created effect appears to cause the page to significantly change its structure. In this section, we briefly explore some applications of DHTML.</p>
<p class="indent">As our first example of DHTML, we use JavaScript to move items around the screen. With recent browsers, this has become much easier because the same methods and <a id="page_783"/>properties can be used to create a cross-browser solution. As an example, imagine if we have a <span class="codesample"><strong>&lt;div&gt;</strong></span> tag with some styling or even an image in it:</p>
<p class="image"><img alt="image" src="f0783-01.jpg"/></p>
<p class="noindent">Setting new properties is as simple as retrieving the element and modifying the property. In most cases, the property will be a property of the <span class="codesample">style</span> object:</p>
<p class="image"><img alt="image" src="f0783-02.jpg"/></p>
<p class="noindent">In this example, the <span class="codesample">left</span> and <span class="codesample">top</span> properties were modified to move the object within the page.</p>
<p class="indent">These can be generalized into functions for reuse:</p>
<p class="image"><img alt="image" src="f0783-03.jpg"/></p>
<p class="noindent">In addition to <span class="codesample"><em>setX()</em></span> and <span class="codesample"><em>setY()</em></span>, it would be logical to have <span class="codesample"><em>setZ()</em></span>, <span class="codesample"><em>setWidth()</em></span>, and <span class="codesample"><em>setHeight()</em></span>, which follow the same principles.</p>
<p class="indent">One interesting thing to note is that <span class="codesample"><em>getX()</em></span> or <span class="codesample"><em>getY()</em></span> is not shown immediately. The reason is that if the <span class="codesample">top</span> or left values are not set in line with CSS or by JavaScript, they will not return a value. Instead, we add in a <span class="codesample"><em>getStyle()</em></span> function, which uses <span class="codesample">getComputedStyle()</span> to retrieve the actual value if the property is not set via JavaScript:</p>
<p class="image"><img alt="image" src="f0783-04.jpg"/></p>
<p class="indent"><a id="page_784"/>Now that these functions have been established, it is simple to move elements around a page. We can easily add show/hide functions or even content changes with <span class="codesample">innerHTML</span> quite easily. An example online and shown in <a class="nounder" href="ch17.html#fig17-4">Figure 17-4</a> demonstrates all of these.</p>
<p class="image1"><a id="fig17-4"/><img alt="image" src="f0784-01.jpg"/></p>
<p class="figcap"><strong>Figure 17-4</strong> Testing simple DHTML with layerlib.js</p>
<hr/>
<p class="online"><strong>ONLINE</strong> <a class="nounder" href="http://www.www.javascriptref.com/3ed/ch17/layers.html">http://www.javascriptref.com/3ed/ch17/layers.html</a></p>
<hr/>
<p class="online"><strong>ONLINE</strong> http://www.javascriptref.com/3ed/ch17/layerlib.js</p>
<p class="indent">Next, we expand our JavaScript-driven excitement by adding some simple functions to create DHTML animation. Traditionally, <span class="codesample">setTimeout()</span> and <span class="codesample">setInterval()</span> have been used to implement such animations. As we will see later in the chapter, <span class="codesample">requestAnimationFrame()</span> is an attempt to optimize the browser performance of animations. In our example, a UFO is added to the page in the form of an <span class="codesample"><strong>&lt;img&gt;</strong></span> tag embedded in a <span class="codesample"><strong>&lt;div&gt;</strong></span> tag. The user is able to choose to move the UFO up, down, right, or left, which is changed by the previously mentioned <span class="codesample"><em>getX()</em></span> / <span class="codesample"><em>setX()</em></span> and <span class="codesample"><em>getY()</em></span> / <span class="codesample"><em>setY()</em></span> functions. We add in timers to repeat movements until various boundary values are hit to give the illusion of some constant movement.</p>
<p class="indent">As a simple example, looking at the <span class="codesample"><em>up()</em></span> function in the following listing, we see that the UFO is retrieved and then <span class="codesample"><em>getY()</em></span> is called to find out the current location of the UFO. The <span class="codesample"><em>getY()</em></span> function is simply a wrapper for the <span class="codesample"><em>getStyle()</em></span> function discussed in the previous section. The current position is checked to see if it is at the top. If it is not, the y coordinate is changed and then <span class="codesample">setTimeout()</span> is called so that the same procedure will <a id="page_785"/>be executed again to give the illusion of constant movement. Once the UFO reaches the top, the animation stops repeating:</p>
<p class="image"><img alt="image" src="f0785-01.jpg"/></p>
<hr/>
<p class="online"><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/ufo.html">http://javascriptref.com/3ed/ch17/ufo.html</a></p>
<p class="indent">To demonstrate the use of <span class="codesample">setInterval()</span> for DHTML animation, we present a simple JavaScript that reveals a page. In this case, two <span class="codesample"><strong>&lt;div&gt;</strong></span> tags are created and placed on top of the HTML content, and then <span class="codesample">setInterval()</span> is set to change the clipping dimensions of the <span class="codesample"><strong>&lt;div&gt;</strong></span> tags continuously until the page is open. We omit the code in print and direct readers online if they want to see the technique in detail:</p>
<hr/>
<p class="online"><strong>ONLINE</strong> <a class="nounder" href="http://www.www.javascriptref.com/3ed/ch17/wipeout.html">http://www.javascriptref.com/3ed/ch17/wipeout.html</a></p>
<p class="indent">What is interesting about much of what is classic DHTML is that it simply isn’t as useful anymore. In fact, CSS animations and transforms could allow you to make a similar “wipeout” demo without any code at all. We show the code here so you see the declarative nature of CSS specifying an animation:</p>
<p class="image"><img alt="image" src="f0785-02.jpg"/></p>
<p class="image"><img alt="image" src="f0785-03.jpg"/></p>
<p class="image"><a id="page_786"/><img alt="image" src="f0785-04.jpg"/></p>
<p class="image"><img alt="image" src="f0785-05.jpg"/></p>
<hr/>
<p class="online"><a id="page_787"/><strong>ONLINE</strong> <a class="nounder" href="http://www.www.javascriptref.com/3ed/ch17/wipeout-css.html">http://www.javascriptref.com/3ed/ch17/wipeout-css.html</a></p>
<p class="indent"><a id="page_788"/>Like the rollover example using just CSS, we note that fine-grain control isn’t really possible with pure CSS solutions (at least at this point). We expect this to change in the future, but readers shouldn’t preclude the use of JavaScript when performing DHTML-style animation because it might really be needed!</p>
<p class="indent">Finally, we hope readers noticed quite quickly the significant number of vendor prefixing required to make the example work in shipping browsers at the time this edition was written. We added properties without them in hope that in the future this will straighten out. There are other solutions that even use JavaScript to insert all these prefixes dynamically, but that kind of defeats the whole point. What we aim to point out is that, while the technology has changed for the dynamic effect, the nightmare of cross-browser issues continues unabated. Standards certainly help, but if we are honest we must acknowledge that they take a while to be adopted.</p>
<h4 class="h4"><a id="ch17lev1sec3"/><strong>Client-Side Bitmap Graphics with &lt;canvas&gt;</strong></h4>
<p class="noindent">The <span class="codesample"><strong>canvas</strong></span> element is used to render simple bitmap graphics such as line art, graphs, and other custom graphical elements on the client side. Initially introduced in the summer of 2004 by Apple in its Safari browser, the <span class="codesample"><strong>canvas</strong></span> element is now supported in many browsers, including Firefox 1.5+, Opera 9+, Internet Explorer 9+, and Safari 2+, and as such is included in the HTML5 specification. While prior to version 9 Internet Explorer did not directly support the tag, there are JavaScript libraries that emulate <span class="codesample"><strong>&lt;canvas&gt;</strong></span> syntax using Microsoft’s Vector Markup Language (VML). (Circa late 2012, the most popular IE <span class="codesample"><strong>&lt;canvas&gt;</strong></span> emulation library is explorercanvas, available at <a class="nounder" href="http://www.code.google.com/p/explorercanvas/">http://code.google.com/p/explorercanvas/</a>.) We’ll look at Scalable Vector Graphics (SVG), the successor to VML, as an alternative to <span class="codesample"><strong>canvas</strong></span> later in the chapter. For now, let’s explore what the Canvas API has to offer.</p>
<p class="indent">From a markup point of view, there is little that you can do with a <span class="codesample"><strong>&lt;canvas&gt;</strong></span> tag. You simply put the element in the page, name it with an <span class="codesample"><strong>id</strong></span> attribute, and define its dimensions with <span class="codesample"><strong>height</strong></span> and <span class="codesample"><strong>width</strong></span> attributes:</p>
<p class="image"><img alt="image" src="f0788-01.jpg"/></p>
<hr/>
<p class="note"><strong>NOTE</strong> The alternative content placed within the element is displayed for browsers that don’t support the canvas element.</p>
<p class="indent">After a <span class="codesample"><strong>&lt;canvas&gt;</strong></span> tag is placed in a document, the next step is to use JavaScript to access and draw on the element. For example, the following fetches the object by its <span class="codesample"><strong>id</strong></span> value and creates a two-dimensional drawing context:</p>
<p class="image"><img alt="image" src="f0788-02.jpg"/></p>
<hr/>
<p class="note"><strong>NOTE</strong> 3D drawing is coming to <span class="codesample"><strong>&lt;canvas&gt;</strong></span> but is not currently defined outside of extensions.</p>
<p class="noindent"><a id="page_789"/>In order to programmatically check for canvas support, it is as simple as seeing if the <span class="codesample">getContext()</span> method exists on the <span class="codesample"><strong>canvas</strong></span> element:</p>
<p class="image"><img alt="image" src="f0789-01.jpg"/></p>
<p class="indent">The basic properties of methods for manipulating a <span class="codesample">canvas</span> object are shown in <a class="nounder" href="ch17.html#tab17-2">Table 17-2</a>.</p>
<p class="tabcap"><a id="tab17-2"/><strong>Table 17-2</strong> Basic canvas Properties and Methods</p>
<p class="image"><img alt="image" src="t0789-01.jpg"/></p>
<p class="indent">Once you have the drawing context, various methods can be used to draw on it. For example, the <span class="codesample">strokeRect</span> (<span class="codesample"><em>x,y,width,height</em></span>) method takes <span class="codesample"><em>x</em></span> and <span class="codesample"><em>y</em></span> coordinates and <span class="codesample"><em>height</em></span> and <span class="codesample"><em>width</em></span>, all specified as numbers representing pixels. For example, the following would draw a simple rectangle of 150 pixels by 50 pixels starting at the coordinate 10,10 from the origin of the placed <span class="codesample"><strong>&lt;canvas&gt;</strong></span> tag:</p>
<p class="image"><img alt="image" src="f0789-02.jpg"/></p>
<p class="noindent">In order to set a particular color for the stroke, the <span class="codesample">strokeStyle()</span> property can be set, like so:</p>
<p class="image"><img alt="image" src="f0789-03.jpg"/></p>
<p class="indent">In order to make a solid rectangle, the fillRect(<span class="codesample"><em>x,y,width,height</em></span>) method can be employed:</p>
<p class="image"><img alt="image" src="f0789-04.jpg"/></p>
<p class="indent">The rectangle methods are shown here in <a class="nounder" href="ch17.html#tab17-3">Table 17-3</a>.</p>
<p class="tabcap"><a id="tab17-3"/><strong>Table 17-3</strong> Rectangle Methods for canvas</p>
<p class="image"><img alt="image" src="t0790-01.jpg"/></p>
<p class="indent">By default, the fill color will be black, but a different fill color can be defined by setting the <span class="codesample">fillStyle()</span> property; this example sets a light-red color:</p>
<p class="image"><img alt="image" src="f0789-05.jpg"/></p>
<p class="indent"><a id="page_790"/>Standard CSS color functions, which may include opacity, may be used; for example, here the opacity of the reddish fill is set to 40 percent:</p>
<p class="image"><img alt="image" src="f0790-01.jpg"/></p>
<p class="indent">A full example using the first <span class="codesample"><strong>canvas</strong></span> element and associated JavaScript is presented here:</p>
<p class="image"><img alt="image" src="f0790-02.jpg"/></p>
<hr/>
<p class="online"><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/canvas.html">http://javascriptref.com/3ed/ch17/canvas.html</a></p>
<p class="indent">In a supporting browser, the simple example draws some rectangles:</p>
<p class="image1"><a id="page_791"/><img alt="image" src="f0791-01.jpg"/></p>
<p class="noindent">Unfortunately, Internet Explorer up to version 8 will not be able to render the example without a compatibility library:</p>
<p class="image1"><img alt="image" src="f0791-02.jpg"/></p>
<p class="noindent">Reworking the example to add just such a library makes things work just fine:</p>
<p class="image1"><img alt="image" src="f0791-03.jpg"/></p>
<hr/>
<p class="online"><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/canvasie.html">http://javascriptref.com/3ed/ch17/canvasie.html</a></p>
<h5 class="h5"><a id="page_792"/><a id="ch17lev2sec2"/><strong>Drawing and Styling Lines and Shapes</strong></h5>
<p class="noindent">HTML5 defines a complete API for drawing on a <span class="codesample"><strong>canvas</strong></span> element, which is composed of many individual sub-APIs for common tasks. For example, to do some more complex shapes, the path API must be used. The path API stores a collection of subpaths formed by various shape functions and connects the subpaths via a <span class="codesample">fill()</span> or <span class="codesample">stroke()</span> call. To begin a path, <span class="codesample">beginPath()</span> is called to reset the path collection. Then, any variety of shape calls can occur to add a subpath to the collection. Once all subpaths are properly added, <span class="codesample">closePath()</span> can optionally be called to close the loop. Then <span class="codesample">fill()</span> or <span class="codesample">stroke()</span> will display the path as a newly created shape. This simple example draws a <em>V</em> shape using <span class="codesample">lineTo()</span>:</p>
<p class="image"><img alt="image" src="f0792-01.jpg"/></p>
<p class="noindent">Now, if <span class="codesample">closePath()</span> were added before <span class="codesample">stroke()</span>, the <em>V</em> shape would turn into a triangle because <span class="codesample">closePath()</span> would connect the last point and the first point.</p>
<p class="indent">Also, by calling <span class="codesample">fill()</span> instead of <span class="codesample">stroke()</span>, the triangle will be filled in with whatever the fill color is, or black if none is specified. Of course, both <span class="codesample">fill()</span> and <span class="codesample">stroke()</span> can be called on any drawn shape if you want to have a stroke around a filled region. Thus, to style the drawing, both the <span class="codesample">fillStyle</span> and <span class="codesample">strokeStyle</span> can be specified, as shown in this example:</p>
<p class="image"><img alt="image" src="f0792-02.jpg"/></p>
<p class="indent">As seen in the previous example, the <span class="codesample">lineWidth</span> property can be set to specify the width of the line. In addition to <span class="codesample">lineWidth</span>, there are a few other properties that customize the style of the line. The <span class="codesample">lineCap</span> property defines the ending that is put on the line. The possible choices are <span class="codesample">butt</span>, <span class="codesample">square</span>, and <span class="codesample">round</span>. The differences are shown here:</p>
<p class="image1"><img alt="image" src="f0792-03.jpg"/></p>
<p class="indent"><a id="page_793"/>The next property relevant to drawing lines is <span class="codesample">lineJoin</span>. This property indicates how the corners should be styled when two lines meet. The choices are <span class="codesample">miter</span>, <span class="codesample">bevel</span>, and <span class="codesample">round</span>. If <span class="codesample">lineJoin</span> is set to <span class="codesample">miter</span>, the <span class="codesample">miterLimit</span> property can be set to indicate the maximum length the line will be extended. The following image illustrates the differences in the <span class="codesample">lineJoin</span> options:</p>
<p class="image1"><img alt="image" src="f0793-01.jpg"/></p>
<p class="indent"><a class="nounder" href="ch17.html#tab17-4">Table 17-4</a> contains the list of line properties.</p>
<p class="tabcap"><a id="tab17-4"/><strong>Table 17-4</strong> Line Properties for canvas</p>
<p class="image"><img alt="image" src="t0793-01.jpg"/></p>
<h5 class="h5"><a id="ch17lev2sec3"/><strong>Drawing Arcs and Curves</strong></h5>
<p class="noindent">Drawing on a <span class="codesample"><strong>&lt;canvas&gt;</strong></span> isn’t limited to simple lines; it is also possible to create curved lines using <span class="codesample">arc()</span>, <span class="codesample">arcTo()</span>, <span class="codesample">quadraticCurveTo()</span>, and <span class="codesample">bezierCurveTo()</span>. To illustrate these methods, this section shows how to draw a simple face.</p>
<p class="indent">The <span class="codesample">arc(<em>x,y, radius, startAngle, endAngle, counterclockwise</em>)</span> method can be used to draw circles and parts of circles. Its location is defined by the point of its center (<span class="codesample"><em>x,y</em></span>) as well as the circle’s <span class="codesample"><em>radius</em></span>. How much of the circle is drawn is defined by <span class="codesample"><em>startAngle</em></span> and <span class="codesample"><em>endAngle</em></span>, in radians. The direction of the curve is set by a Boolean value, which is the final parameter specified by <span class="codesample"><em>counterclockwise</em></span>. If it is set to <span class="codesample">true</span>, the curve will move counterclockwise; otherwise, it will move clockwise. In case your math is a bit rusty, to make a full circle, the start angle should be set to 0 and the end angle should be 2π. So, to start the face drawing, <span class="codesample">arc()</span> is used to draw the head as a circle:</p>
<p class="image"><img alt="image" src="f0793-02.jpg"/></p>
<p class="indent"><a id="page_794"/>Use the <span class="codesample">quadraticCurveTo(<em>cpx,cpy,x,y</em>)</span> method to draw the nose and the mouth. This function starts at the last point in the path and draws a line to (<span class="codesample"><em>x,y</em>)</span>. The control point (<span class="codesample"><em>cpx,cpy</em></span>) is used to pull the line in that direction, resulting in a curved line. However, <span class="codesample">moveTo()</span> can be called first to set the last point in the path. In the following snippet, a line was drawn from <span class="codesample">(155,130)</span> to <span class="codesample">(155,155)</span>. Because the x-coordinate of the control point <span class="codesample">(130,145)</span> is to the left, the line is pulled in that direction. Because the y-coordinate is in between the y-coordinates, the pull is roughly in the middle:</p>
<p class="image"><img alt="image" src="f0794-01.jpg"/></p>
<p class="indent">The <span class="codesample">bezierCurveTo(<em>cp1x,cp1y,cp2x,cp2y,x,y</em>)</span> method can be used to draw the eyes. This function is similar to <span class="codesample">quadraticCurveTo()</span>, except that it has two control points and has a line that is pulled toward both of them. Again, <span class="codesample">moveTo()</span> is used to set the start point of the line:</p>
<p class="image"><img alt="image" src="f0794-02.jpg"/></p>
<p class="indent">Lastly, use <span class="codesample">arcTo (<em>x1,y1,x2,y2,radius</em>)</span> to draw a frame around the face. Unfortunately, foreshadowing some issues with the Canvas API, we note that <span class="codesample">arcTo()</span> is not currently supported properly in all browsers, so it may render oddly. When it does work, it creates two lines and then draws an arc with the radius specified and containing a point tangent to each of the lines. The first line is drawn from the last point in the subpath to <span class="codesample">(<em>x1,y1</em>)</span>, and the second line is drawn from <span class="codesample">(<em>x1,y1</em>)</span> to <span class="codesample">(<em>x2,y2</em>)</span>:</p>
<p class="image"><img alt="image" src="f0794-03.jpg"/></p>
<p class="indent">The complete example is shown next. Note that, given layering, the frame and face are drawn and filled in first, and the features are drawn last. Also note that the paths are reset with the <span class="codesample">beginPath()</span> method. Commonly, people forget to do this, which can produce some interesting drawings. A rendering of the face example is shown in <a class="nounder" href="ch17.html#fig17-5">Figure 17-5</a>.</p>
<p class="image1"><a id="fig17-5"/><img alt="image" src="f0796-01.jpg"/></p>
<p class="figcap"><strong>Figure 17-5</strong> Drawing a canvas smiley</p>
<p class="image"><img alt="image" src="f0794-04.jpg"/></p>
<p class="image0"><img alt="image" src="f0794-05.jpg"/></p>
<hr/>
<p class="online"><a id="page_795"/><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/canvasface.html">http://javascriptref.com/3ed/ch17/canvasface.html</a></p>
<p class="indent">The methods of the Path API are described in <a class="nounder" href="ch17.html#tab17-5">Table 17-5</a>.</p>
<p class="tabcap"><a id="tab17-5"/><strong>Table 17-5</strong> Path API Methods for canvas</p>
<p class="imagea"><img alt="image" src="t0796-01.jpg"/></p>
<p class="image0"><img alt="image" src="t0797-01.jpg"/></p>
<p class="indent">As seen in a few previous examples, the fill color can be changed by setting the <span class="codesample">fillStyle</span> property. In addition to the CSS color values, the <span class="codesample">fillStyle</span> can also be set to a gradient object. A gradient object can be created by using <span class="codesample">createLinearGradient()</span> or <span class="codesample">createRadialGradient()</span>.<a id="page_796"/></p>
<p class="indent"><a id="page_797"/>The following example creates a simple linear gradient that will be applied to a rectangle using the <span class="codesample">createLinearGradient(<em>x1,y1,x2,y2</em>)</span> method. The gradient is positioned at 10,150 and is set to go 200 pixels in both directions.</p>
<p class="image"><img alt="image" src="f0797-01.jpg"/></p>
<p class="noindent">Next, the gradient colors are added using the <span class="codesample">addColorStop()</span> method. This specifies a color and the offset position in the gradient where the color should occur. The offset must be between <span class="codesample">0</span> and <span class="codesample">1</span>:</p>
<p class="image"><img alt="image" src="f0797-02.jpg"/></p>
<p class="indent">Of course, the <span class="codesample">rgba</span> CSS function could be used to create a gradient with transparency as well. After the <span class="codesample">addColorStop()</span> methods have been added, the <span class="codesample">fillStyle</span> is set to the newly created <span class="codesample">Gradient</span> object. Here is the complete code snippet, followed by a visual example:</p>
<p class="image"><img alt="image" src="f0797-03.jpg"/></p>
<p class="image1"><a id="page_798"/><img alt="image" src="f0798-01.jpg"/></p>
<p class="noindent">Note that before the shape is drawn, the path is reset to ensure that these changes are not applied to previously rendered parts of the drawing.</p>
<p class="indent">To create a radial gradient using <span class="codesample">createRadialGradient(<em>x1,y1,r1,x2,y2,r2</em>)</span>, the position and radius of two circles must be set to serve as the gradient. Once again, color stops are added in the same manner as the linear gradient, so the code looks quite similar:</p>
<p class="image"><img alt="image" src="f0798-02.jpg"/></p>
<p class="image1"><img alt="image" src="f0798-03.jpg"/></p>
<p class="indent">The complete example, drawing a few different shapes with fills and styles, is presented here:</p>
<p class="image"><img alt="image" src="f0798-04.jpg"/></p>
<p class="image"><img alt="image" src="f0798-05.jpg"/></p>
<hr/>
<p class="online"><a id="page_799"/><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/canvaslinesandshapes.html">http://javascriptref.com/3ed/ch17/canvaslinesandshapes.html</a></p>
<p class="indent"><a class="nounder" href="ch17.html#tab17-6">Table 17-6</a> shows the complete list of style and color properties.</p>
<p class="tabcap"><a id="tab17-6"/><strong>Table 17-6</strong> Color and Style Properties and Methods for canvas</p>
<p class="imagea"><img alt="image" src="t0800-01.jpg"/></p>
<p class="image0"><img alt="image" src="t0800-02.jpg"/></p>
<h6 class="h6"><a id="page_800"/><strong>Applying Some Perspective</strong></h6>
<p class="noindent">As the context is specified as <span class="codesample">2d</span>, it is no surprise that everything seen so far has been two-dimensional. It is possible to add some perspective by choosing proper points and shades. The 3-D cube shown in <a class="nounder" href="ch17.html#fig17-6">Figure 17-6</a> is created using nothing more than several <span class="codesample">moveTo()</span> and <span class="codesample">lineTo()</span> calls. The <span class="codesample">lineTo()</span> call is used to create three sides of the cube, but the points set are not straight horizontal and vertical lines, as we see when making two-dimensional squares. Shading is applied to give the illusion of dimensionality because of the application of a light source. While the code here is pretty simple, you can see that using a <span class="codesample"><strong>canvas</strong></span> properly is often a function more of what you may know about basic geometry and drawing than anything else:</p>
<p class="image1"><a id="fig17-6"/><img alt="image" src="f0802-01.jpg"/></p>
<p class="figcap"><strong>Figure 17-6</strong> Faking 3-D with perspective</p>
<p class="image"><img alt="image" src="f0801-01.jpg"/></p>
<p class="image"><img alt="image" src="f0801-02.jpg"/></p>
<hr/>
<p class="online"><a id="page_801"/><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/canvascube.html">http://javascriptref.com/3ed/ch17/canvascube.html</a></p>
<h5 class="h5"><a id="page_802"/><a id="ch17lev2sec4"/><strong>Scaling, Rotating, and Translating Drawings</strong></h5>
<p class="noindent">We now have looked at the basic shapes and styling, but there is much more that can be done to customize a drawing through transformations. The Canvas API provides a number of useful methods that accomplish the common tasks you will likely want to perform. First let’s explore the <span class="codesample">scale(<em>x,y</em>)</span> function, which can be used to scale objects. The <span class="codesample"><em>x</em></span> parameter shows how much to scale in the horizontal direction, and the <span class="codesample"><em>y</em></span> parameter indicates how much to scale vertically:</p>
<p class="image"><img alt="image" src="f0802-02.jpg"/></p>
<p class="image1"><a id="page_803"/><img alt="image" src="f0803-01.jpg"/></p>
<hr/>
<p class="online"><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/canvasscale.html">http://javascriptref.com/3ed/ch17/canvasscale.html</a></p>
<p class="indent">Next up is the <span class="codesample">rotate(<em>angle</em>)</span> method, which can be used to rotate a drawing in a clockwise direction by an <span class="codesample"><em>angle</em></span> defined in radians:</p>
<p class="image"><img alt="image" src="f0803-02.jpg"/></p>
<p class="image1"><img alt="image" src="f0803-03.jpg"/></p>
<hr/>
<p class="online"><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/canvasrotate.html">http://javascriptref.com/3ed/ch17/canvasrotate.html</a></p>
<p class="indent">The <span class="codesample">translate(<em>x,y</em>)</span> function is a handy function to use to change the origin from <span class="codesample">(0,0)</span> to another location in the drawing. The following example moves the origin to <span class="codesample">(100,100)</span>. Then, when the start coordinates of the rectangle are specified at <span class="codesample">(0,0)</span>, it really starts at <span class="codesample">(100,100)</span>:</p>
<p class="image"><img alt="image" src="f0803-04.jpg"/></p>
<p class="indent"><a id="page_804"/>A simple example of moving some boxes around is shown here:</p>
<p class="image1"><img alt="image" src="f0804-01.jpg"/></p>
<hr/>
<p class="online"><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/canvastranslate.html">http://javascriptref.com/3ed/ch17/canvastranslate.html</a></p>
<p class="indent">All the methods presented so far are conveniences to help us use an underlying transform matrix associated with paths. All paths have an identity matrix as their default transform. As an identity, this transform matrix does nothing, but it is certainly possible to adjust this matrix in a few ways. First, it can be directly modified by calling <span class="codesample">setTransform (<em>m11,m12,m21,m22,dx,dy</em>)</span>, which resets the matrix to the identity matrix and then calls <span class="codesample">transform()</span> with the given parameters. Or this can be done directly by using <span class="codesample">transform(<em>m11,m12,m21,m22,dx,dy</em>)</span>, which multiplies whatever the current matrix is with the matrix defined here:</p>
<p class="image"><img alt="image" src="f0804-02.jpg"/></p>
<p class="indent">The problem with the method should be obvious: unless you understand more than a bit about matrix math, this can be a little daunting to use. On the bright side, you can do just about anything you want with the method. Here, a simple example skews and moves some simple rectangles. The result is shown in <a class="nounder" href="ch17.html#fig17-7">Figure 17-7</a>.</p>
<p class="image1"><a id="fig17-7"/><img alt="image" src="f0805-01.jpg"/></p>
<p class="figcap"><strong>Figure 17-7</strong> Transforming a rectangle</p>
<p class="image"><img alt="image" src="f0804-03.jpg"/></p>
<p class="image"><img alt="image" src="f0804-04.jpg"/></p>
<hr/>
<p class="online"><a id="page_805"/><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/canvastransform.html">http://javascriptref.com/3ed/ch17/canvastransform.html</a></p>
<p class="indent"><a id="page_806"/>The transformation methods are listed in <a class="nounder" href="ch17.html#tab17-7">Table 17-7</a>.</p>
<p class="tabcap"><a id="tab17-7"/><strong>Table 17-7</strong> Primary canvas Transformation Methods</p>
<p class="image"><img alt="image" src="t0806-01.jpg"/></p>
<h5 class="h5"><a id="ch17lev2sec5"/><strong>Using Bitmaps in Drawings</strong></h5>
<p class="noindent">A very interesting feature of the Canvas API is the ability to insert images into the drawing. There are several ways to do this, but let’s start with the most basic, <span class="codesample">drawImage(<em>img,x,y</em>)</span>, which takes an image object and the coordinates for where the image should be placed. The image will be its natural size when called in this manner. The <span class="codesample">drawImage(<em>img,x,y,w,h</em>)</span> method can be used if you need to modify the image size and set the width and height.</p>
<p class="indent">The actual image passed in to the <span class="codesample">drawImage()</span> method can come from a few places:</p>
<p class="bullettop">• An image already loaded on the page</p>
<p class="bullet">• Can be dynamically created through the DOM</p>
<p class="bullet">• Another <span class="codesample">canvas</span> object</p>
<p class="bullet">• An image created by setting its <span class="codesample">src</span> to a <span class="codesample">data</span>: URL</p>
<p class="noindenttop">The important thing to remember is that the image must be loaded by the time <span class="codesample"><strong>canvas</strong></span> is ready to access it. This may require the use of the <span class="codesample">onload</span> function for the image:</p>
<p class="image"><img alt="image" src="f0806-01.jpg"/></p>
<p class="indent"><a id="page_807"/>The last way that <span class="codesample">drawImage(<em>img,sx,sy,sw,sh,dx,dy,dw,dh</em>)</span> may be called allows a part of the image to be cut out and drawn to the <span class="codesample"><strong>canvas</strong></span>. The <span class="codesample">(<em>sx,sy</em>)</span> coordinates are the location on the image, and <span class="codesample"><em>sw</em></span> and <span class="codesample"><em>sh</em></span> are the width and height, respectively. The rest of the parameters prefixed with <span class="codesample"><em>d</em></span> are the same as in the previous form of the method:</p>
<p class="image"><img alt="image" src="f0807-01.jpg"/></p>
<p class="indent">However you decide to place it, once an image is on the <span class="codesample"><strong>canvas</strong></span> it is then possible to draw on it. The following example loads an image and draws a region in preparation for eventually adding a caption:</p>
<p class="image"><img alt="image" src="f0807-02.jpg"/></p>
<p class="image"><img alt="image" src="f0807-03.jpg"/></p>
<hr/>
<p class="online"><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/canvasimage.html">http://javascriptref.com/3ed/ch17/canvasimage.html</a></p>
<p class="indent">The Image API methods and properties are shown in <a class="nounder" href="ch17.html#tab17-8">Table 17-8</a>.</p>
<p class="tabcap"><a id="tab17-8"/><strong>Table 17-8</strong> ImageData API Methods and Properties for canvas</p>
<p class="imagea"><img alt="image" src="t0808-01.jpg"/></p>
<p class="image0"><img alt="image" src="t0808-02.jpg"/></p>
<h5 class="h5"><a id="page_808"/><a id="ch17lev2sec6"/><strong>Text Support for &lt;canvas&gt;</strong></h5>
<p class="noindent">In browsers that supported early forms of the <span class="codesample"><strong>canvas</strong></span> element, text was not well supported in a drawing, if at all. Per HTML5, text functions should now be supported by the Canvas API, and the modern browsers do support it. Text can be written by using <span class="codesample">fillText(<em>text,x</em>,y <em>[,maxWidth]</em>)</span> or <span class="codesample">strokeText(<em>text,x,y [,maxWidth]</em>)</span>. Both functions take an optional last parameter, <span class="codesample"><em>maxWidth</em></span>, that will cut the text off if the width is longer than specified. The <span class="codesample">fillText()</span> and <span class="codesample">strokeText()</span> methods can both be utilized to display an outline around the text. Here, a fill color of blue is set and then the phrase “Canvas is great!” is written with a black stroke around the letters:</p>
<p class="image"><img alt="image" src="f0808-01.jpg"/></p>
<p class="indent"><a id="page_809"/>To get more customized text, the <span class="codesample">font</span> property can be used. The <span class="codesample">font</span> property is set identically to a CSS <span class="codesample">font</span> property. The <span class="codesample">textAlign</span> and <span class="codesample">textBaseline</span> can be used to set the horizontal and vertical alignment of the text string. The <span class="codesample">textAlign</span> property has the possible values of <span class="codesample">start, end, left, right</span>, and <span class="codesample">center</span>. The <span class="codesample">textBaseline</span> property can be set to <span class="codesample">top</span>, <span class="codesample">hanging</span>, <span class="codesample">middle</span>, <span class="codesample">alphabetic</span>, <span class="codesample">ideographic</span>, and <span class="codesample">bottom</span>:</p>
<p class="image"><img alt="image" src="f0809-01.jpg"/></p>
<p class="indent">Shadows can be added to shapes simply by setting the shadow properties, <span class="codesample">shadowOffsetX</span>, <span class="codesample">shadowOffsetY</span>, <span class="codesample">shadowBlur</span>, and <span class="codesample">shadowColor</span>. The offsets simply set how far the shadow should be offset from the image. A positive number would make the shadow go to the right and down. A negative number would make it go to the left and up. The <span class="codesample">shadowBlur</span> property indicates how blurred the shadow will be, and the <span class="codesample">shadowColor</span> property indicates the color. This code fragment demonstrates setting a shadow:</p>
<p class="image"><img alt="image" src="f0809-02.jpg"/></p>
<p class="indent">The shadow properties are shown in <a class="nounder" href="ch17.html#tab17-9">Table 17-9</a>.</p>
<p class="tabcap"><a id="tab17-9"/><strong>Table 17-9</strong> Shadow Properties for canvas</p>
<p class="image"><img alt="image" src="t0809-01.jpg"/></p>
<p class="indent">All the concepts from this and the last section can be put together as follows to caption an image with some shadowed text, as shown in <a class="nounder" href="ch17.html#fig17-8">Figure 17-8</a>:</p>
<p class="image"><a id="fig17-8"/><img alt="image" src="f0811-01.jpg"/></p>
<p class="figcap"><strong>Figure 17-8</strong> Even dogs love &lt;canvas&gt;.</p>
<p class="image"><a id="page_810"/><img alt="image" src="f0810-01.jpg"/></p>
<p class="image"><img alt="image" src="f0810-02.jpg"/></p>
<hr/>
<p class="online"><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/canvastext.html">http://javascriptref.com/3ed/ch17/canvastext.html</a></p>
<p class="indent">The canvas text methods and properties are shown in <a class="nounder" href="ch17.html#tab17-10">Table 17-10</a>.</p>
<p class="tabcap"><a id="tab17-10"/><strong>Table 17-10</strong> Text API Methods and Properties for canvas<a id="page_811"/></p>
<p class="image"><img alt="image" src="t0811-01.jpg"/></p>
<h5 class="h5"><a id="page_812"/><a id="ch17lev2sec7"/><strong>Compositing</strong></h5>
<p class="noindent">Now that we have seen how to draw many different types of images, it is necessary to discuss how the shapes will lay out on the canvas when multiple drawings are added. The property <span class="codesample">globalCompositeOperation</span> is used to specify the manner in which shapes are layered. <a class="nounder" href="ch17.html#tab17-11">Table 17-11</a> shows the many options of <span class="codesample">globalCompositeOperation</span>. In all cases, <em>A</em> is the new shape being drawn and <em>B</em> is the current canvas. The default is <span class="codesample">source-over</span>, which indicates that the newly added shape will be placed on top of the current canvas.</p>
<p class="tabcap"><a id="tab17-11"/><strong>Table 17-11</strong> Compositing Options for canvas</p>
<p class="imagea"><img alt="image" src="t0812-01.jpg"/></p>
<p class="image0"><img alt="image" src="t0812-02.jpg"/></p>
<p class="indent">In all cases, the squares are being drawn with the same code. The red square is being written first and, therefore, is represented by <em>B</em> when the green square (<em>A</em>) is written:</p>
<p class="image"><img alt="image" src="f0812-01.jpg"/></p>
<p class="noindent"><a id="page_813"/>The only difference is the setting of the <span class="codesample">globalCompositeOperation</span>:</p>
<p class="image"><img alt="image" src="f0813-01.jpg"/></p>
<p class="noindent">This capture shows some of the compositing options:</p>
<p class="image1"><img alt="image" src="f0813-02.jpg"/></p>
<p class="indent">In addition to the <span class="codesample">globalCompositeOperation</span>, it is possible to set a <span class="codesample">globalAlpha</span> property. This will be the default transparency value for all drawings. As with other <span class="codesample">alpha</span> values, the value must be between <span class="codesample">0</span> and <span class="codesample">1</span>, with <span class="codesample">0</span> being completely transparent and <span class="codesample">1</span> being completely opaque.</p>
<p class="indent">These properties are shown in <a class="nounder" href="ch17.html#tab17-12">Table 17-12</a>.</p>
<p class="tabcap"><a id="tab17-12"/><strong>Table 17-12</strong> Compositing Properties for canvas</p>
<p class="image"><img alt="image" src="t0813-01.jpg"/></p>
<h5 class="h5"><a id="page_814"/><a id="ch17lev2sec8"/><strong>Saving State</strong></h5>
<p class="noindent">Canvas offers two handy methods for saving and restoring state. In order to save the current state of the canvas, simply call <span class="codesample">save()</span>. Then modify the canvas in any way. Later, it is possible to retrieve the previously saved state by calling <span class="codesample">restore()</span>:</p>
<p class="image"><img alt="image" src="f0814-01.jpg"/></p>
<p class="noindent">In this example, the <span class="codesample">lineWidth</span> is set to <span class="codesample">5</span> and the <span class="codesample">strokeStyle</span> is set to <span class="codesample">red</span>. This state is saved. Then the code goes on to change the width and color. Later, the first state is restored with a call to <span class="codesample">restore()</span>. Note that the location is not saved in state, so it is still necessary to call <span class="codesample">moveTo</span>. These methods are described in <a class="nounder" href="ch17.html#tab17-13">Table 17-13</a>.</p>
<p class="tabcap"><a id="tab17-13"/><strong>Table 17-13</strong> State Preservation Methods for canvas</p>
<p class="image"><img alt="image" src="t0814-01.jpg"/></p>
<h5 class="h5"><a id="ch17lev2sec9"/><strong>&lt;canvas&gt; Considerations</strong></h5>
<p class="noindent">In the following sections, we briefly explore some of the areas of the Canvas API that can require a bit of careful thought. As with anything, there are trade-offs with drawing this way, and while they can be mitigated, there may be a few things we give up in doing so.</p>
<h6 class="h6"><strong>Capturing Events</strong></h6>
<p class="noindent">Since canvas is just a single element, capturing events on individual pieces of the canvas can prove to be challenging. There are many solutions for this problem, and we will look at a couple of them in detail here. Image maps may be the first logical thought. as developers have been using image maps to handle events on pieces of images for many years now. However, it is not currently possible to associate a <span class="codesample"><strong>canvas</strong></span> element with a <span class="codesample"><strong>map</strong></span> element, as is possible with images. This proves not to be a problem, though, as a transparent image can <a id="page_815"/>be placed at the same location as the <span class="codesample"><strong>canvas</strong></span> element, and the image map can be associated with the transparent image:</p>
<p class="image"><img alt="image" src="f0815-01.jpg"/></p>
<p class="noindent">Now that the image map is established, areas must be created to capture events. In this simple example, a rectangle, a triangle, and a circle will be drawn. Each one will capture the <span class="codesample">onmousemove</span> event and then display the coordinates relative to the shape.</p>
<p class="indent">The <span class="codesample"><em>draw()</em></span> function initiates the process by adding details about each shape and calling <span class="codesample"><em>drawShape()</em></span> for each one. The <span class="codesample"><em>drawShape()</em></span> function will call methods to draw the shape and add a corresponding entry in the image map. The <span class="codesample"><em>drawShape()</em></span> function also adds the shape to an array for later retrieval:</p>
<p class="image"><img alt="image" src="f0815-02.jpg"/></p>
<p class="indent">As shown in the code, each <span class="codesample"><em>shape</em></span> object contains relevant coordinates. These coordinates, along with the type, define the shape. These coordinates will be used in <span class="codesample"><em>drawImageMap()</em></span> to create a coordinate string that can be added to the image map at the same location as the shape in the canvas. The <span class="codesample"><em>drawImageMap()</em></span> function also calculates the minimum x and y values for the shape so that the pixel coordinates can be calculated appropriately in the <span class="codesample">onmouseover</span> event:</p>
<p class="image"><img alt="image" src="f0815-03.jpg"/></p>
<p class="image"><img alt="image" src="f0815-04.jpg"/></p>
<p class="noindent"><a id="page_816"/>Finally, the <span class="codesample"><em>addImageMapArea()</em></span> function creates the <span class="codesample"><strong>area</strong></span> element, adds it to the document, and hooks up the events:</p>
<p class="image"><img alt="image" src="f0816-01.jpg"/></p>
<p class="indent">The <span class="codesample"><em>printCoords()</em></span> method gets executed upon each <span class="codesample">mouseover</span> event being fired for each individual <span class="codesample"><strong>area</strong></span> element. Since the shape gets sent to the event handler, it is automatically known what shape is being accessed. The only calculation that needs to happen in the event handler is translating the coordinates to be relative to the shape. As the minimum x and y coordinates have been saved to the <span class="codesample"><em>shape</em></span> object, some trivial calculations will deliver the desired points:</p>
<p class="image"><a id="page_817"/><img alt="image" src="f0817-01.jpg"/></p>
<hr/>
<p class="online"><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/canvasclick.html">http://javascriptref.com/3ed/ch17/canvasclick.html</a></p>
<p class="indent">While the image area method certainly works and is effective, it can also be a memory hog and slow down performance. Keep in mind that every object that needs to handle mouse events will need an area tag associated with it. This can lead to some massive DOM explosion in a large canvas. Similar methods include creating invisible <span class="codesample"><strong>div</strong></span> tags for each shape or even creating a separate <span class="codesample"><strong>canvas</strong></span> element for each shape, but both of these would still cause a large amount of memory overhead.</p>
<p class="indent">The other classification would be pixel management. In this case, during an event, the pixels are inspected to look up a shape that might be at that location. It is possible to create a pixel map where each shape stores the pixel range it encompasses. This might be simple for a rectangle or a circle, but it would require more advanced math for various polygon shapes. Another option is to create a canvas map. In this case, a second hidden canvas is added to the page at the same location as the original:</p>
<p class="image"><img alt="image" src="f0817-02.jpg"/></p>
<p class="indent">The <span class="codesample"><em>drawShape()</em></span> function is modified so that it calls <span class="codesample">drawContext()</span> twice. The first time is with the original settings on the main canvas. The second time, the same shape is added to the hidden canvas with a specified, solid color that is randomly generated. Note that it is necessary for the color to be unique, so a random color is generated until one is found that is not already in the <span class="codesample"><em>colorMap</em></span>:</p>
<p class="image"><img alt="image" src="f0817-03.jpg"/></p>
<p class="indent"><a id="page_818"/>The events are added directly to the main canvas. When the event is captured, the current pixel coordinates are calculated, as shown in the previous example. Once the coordinates are calculated, <span class="codesample">getImageData()</span> is executed on the mapped canvas. Now, it is possible to look at the color of the pixel and check if it is in the <span class="codesample"><em>colorMap</em></span> table. If it is, then the relevant shape is retrieved. Otherwise, the mouse event did not occur on a saved shape. Note that <span class="codesample">getImageData().data</span> returns the color in RGB, while we stored the color in hex. A conversion is necessary before performing the lookup:</p>
<p class="image"><img alt="image" src="f0818-01.jpg"/></p>
<p class="indent">The results are the same as the first example. However, in this case, only one extra DOM element was added to the page. In this small example, the extra DOM elements are not a big deal, but in large scale applications they can have a big effect.</p>
<hr/>
<p class="online"><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/canvaspixelcheck.html">http://javascriptref.com/3ed/ch17/canvaspixelcheck.html</a></p>
<hr/>
<p class="note"><strong>NOTE</strong> As the edition goes to publication, we see the emergence of a hit testing addition to the Canvas API. This welcome change had, as of publication, not been implemented, but it suggests the techniques in this section may be more for backward compatibility rather than primary use sometime in the near future.</p>
<h6 class="h6"><strong>Redrawing</strong></h6>
<p class="noindent">In the previous section, we looked at different methods for capturing events. However, once the events were captured, data about the event was presented to the screen and the original <span class="codesample"><strong>&lt;canvas&gt;</strong></span> stayed intact. It is often desirable to modify the actual <span class="codesample"><strong>&lt;canvas&gt;</strong></span>. There are <a id="page_819"/>two primary ways to go about doing this. The first method requires clearing out the entire <span class="codesample"><strong>&lt;canvas&gt;</strong></span> and redrawing it with the new settings.</p>
<p class="indent">Our running example uses the image map method to capture the click event. When a shape is clicked, the <span class="codesample">fillStyle</span> will be changed to a random color and then the image will be redrawn:</p>
<p class="image"><img alt="image" src="f0819-01.jpg"/></p>
<p class="noindent">The <span class="codesample"><em>redraw()</em></span> method clears the current canvas, loops through the shapes array, and then redraws each of the shapes. As it is not re-creating the <span class="codesample"><em>shape</em></span> objects, the <span class="codesample">fillStyle</span> that was set in the event handler will be set as the color for the shape:</p>
<p class="image"><img alt="image" src="f0819-02.jpg"/></p>
<p class="noindent">Note that only <span class="codesample">drawContext()</span> was called for each shape. This is because the shapes are staying in the same location. If the shape were moving, the image map would have to be regenerated as well. In this case, the image map that was created on initial draw will remain relevant:</p>
<p class="image"><img alt="image" src="f0819-03.jpg"/></p>
<hr/>
<p class="online"><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/canvasclick.html">http://javascriptref.com/3ed/ch17/canvasclick.html</a></p>
<p class="indent">Clearing an entire <span class="codesample"><strong>&lt;canvas&gt;</strong></span> works as expected in this example. In some cases, it is even the correct solution, but consider a <span class="codesample"><strong>&lt;canvas&gt;</strong></span> that has hundreds of shapes and only one is being modified. It would be a waste of resources to redraw the entire thing. Unfortunately, the only way to clear items from a canvas is with the <span class="codesample">clearRect()</span> method. In order to clear individual pieces, <span class="codesample">clearRect()</span> would need to be called on a rectangle that contains the piece to be redrawn. It is very important to note that if the containing rectangle contains any other pieces of the <span class="codesample"><strong>&lt;canvas&gt;</strong></span>, they must be redrawn as well.</p>
<p class="indent">In this case, the <span class="codesample">redraw()</span> function is slightly more complicated, as it calculates the containing rectangle:</p>
<p class="image"><img alt="image" src="f0819-04.jpg"/></p>
<h6 class="h6"><a id="page_820"/><strong>toDataUrl</strong></h6>
<p class="noindent">When allowing a user to modify a canvas, it is often desirable to save that modification. This can be accomplished by using <span class="codesample">canvas.toDataURL()</span> to translate the canvas into an image. In this example, the canvas is copied to a <span class="codesample">dataURL</span> and placed as the <span class="codesample">src</span> of an <span class="codesample"><strong>&lt;image&gt;</strong></span> tag within the page. However, it is possible to take the returned <span class="codesample">dataURL</span> and send it to a server-side program to save or store, depending on the application’s needs:</p>
<p class="image"><img alt="image" src="f0820-01.jpg"/></p>
<hr/>
<p class="online"><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/toDataUrl.html">http://javascriptref.com/3ed/ch17/toDataUrl.html</a></p>
<h6 class="h6"><strong>Animation</strong></h6>
<p class="noindent">At the simplest form, animation is just a matter of redrawing an object in a different position. As we have seen in previous examples, there are a couple of ways to redraw a <span class="codesample">canvas</span> object. In this example, we will see a simplified version of pong with one paddle to catch the ball at the bottom. The paddle can be moved with the right and left arrow keys. If the ball reaches the bottom of the box, the game ends. Since the paddle and ball both need to be redrawn, the clear method of choice is a complete clearing of the <span class="codesample"><strong>&lt;canvas&gt;</strong></span>.</p>
<p class="indent">First, it is necessary to capture the <span class="codesample">keyup</span> and <span class="codesample">keydown</span> events. These events will set Booleans indicating whether or not the left or right arrow keys are being pressed:</p>
<p class="image"><img alt="image" src="f0820-02.jpg"/></p>
<p class="noindent">Then an interval will be set up to run every 10 ms:</p>
<p class="image"><img alt="image" src="f0820-03.jpg"/></p>
<p class="noindent">The bulk of the action occurs in the <span class="codesample"><em>draw()</em></span> method. First, the previous canvas is cleared. Then the ball is drawn as well as the paddle. Finally, the ball is checked to see if it is below the paddle, on the paddle, or elsewhere, and the ball position is adjusted accordingly for <a id="page_821"/>the next call to <span class="codesample"><em>draw()</em></span>. If the ball is below the paddle, the interval is cleared and the animation completes:</p>
<p class="image"><img alt="image" src="f0821-01.jpg"/></p>
<hr/>
<p class="online"><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/animate.html">http://javascriptref.com/3ed/ch17/animate.html</a></p>
<p class="indent">An alternative to the <span class="codesample">setInterval()</span> function for animations is <span class="codesample">requestAnimation Frame(<em>callback</em>)</span>. This function tells the browser that the code is ready for a repaint and that the browser should call the callback function when it is ready to perform the redraw. The <span class="codesample">requestAnimationFrame()</span> technique is preferable to the <span class="codesample">setInterval()</span> method because the browser can optimize when it is called for better performance and memory management. At the time of this book’s release, <span class="codesample">requestAnimationFrame</span> is in the early stages of development and still handled with browser-specific prefixes, so it is necessary to check the various methods before making the call:</p>
<p class="image"><img alt="image" src="f0821-02.jpg"/></p>
<p class="noindent">The <span class="codesample">requestAnimationFrame()</span> method is not an interval, so it is necessary to call it every time you want it to run. To get the fastest performance, it should be called at the beginning of the callback function. In this case, a global variable <span class="codesample">g_stop</span> is set when the ball falls below the paddle. If we reach that point, <span class="codesample">requestAnimationFrame()</span> won’t be called again. Otherwise, it is called before other code is executed:</p>
<p class="image"><img alt="image" src="f0821-03.jpg"/></p>
<hr/>
<p class="online"><a id="page_822"/><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/requestAnimationFrame.html">http://javascriptref.com/3ed/ch17/requestAnimationFrame.html</a></p>
<h6 class="h6"><strong>Support and Differences</strong></h6>
<p class="noindent">Even at this late day, small implementation details vary between browsers and, for now, Internet Explorer versions prior to 9 require a compatibility library even for basic support. Scripting canvas-based drawings for interactivity is a bit clunky, and text support is far from stellar. Accessibility concerns also exist. However, don’t let the challenges dissuade you. Nothing is perfect; we’ll see when discussing SVG next that weaknesses of canvas are strengths for it, but its weaknesses can be canvas strengths. The trade-offs of technology exist no matter what marketers may tell you.</p>
<h4 class="h4"><a id="ch17lev1sec4"/><strong>Client-Side Vector Graphics with SVG</strong></h4>
<p class="noindent">Like Canvas, SVG provides developers a method for providing graphics within an HTML page. However, whereas the Canvas API is primarily script based, SVG is an XML-based language. SVG is rendered using retained-mode graphics. This can be advantageous because the graphic is not redrawn on animation, but simply moved. In addition, considering that SVG is tag based, it is possible to hook events directly to individual elements of the drawing. It is easy to access previously drawn elements and modify them as desired. As we saw in the previous section, this is not as simple using the Canvas API. On the other hand, considering that SVG is tag based, the DOM tree has the potential to grow quite large if there are many elements on the page. Also, as canvas deals directly with pixels, it can be faster for drawing lots of items, especially if there is no interactivity involved. There is a place for both SVG and <span class="codesample"><strong>&lt;canvas&gt;</strong></span>, so let’s take a look now at SVG in detail.</p>
<h5 class="h5"><a id="ch17lev2sec10"/><strong>Including SVG</strong></h5>
<p class="noindent">There are several ways of including an SVG document within an HTML page. The first thought would be to place the <span class="codesample"><strong>&lt;svg&gt;</strong></span> tags directly within the page. In the near future, this should be an appropriate thought, but for now this method is not supported throughout all modern browsers. The most supported method of embedding SVG is to use the <span class="codesample"><strong>&lt;embed&gt;</strong></span> tag:</p>
<p class="image"><img alt="image" src="f0822-01.jpg"/></p>
<p class="noindent">The SVG page should be served with a content-type of <span class="codesample">image/svg+xml</span>.</p>
<p class="indent">Another way to include SVG would be entirely with JavaScript. In this case, all SVG tags will be generated using JavaScript as well. Note that <span class="codesample">createElementNS()</span> must be used, as the SVG elements are from a different namespace than the HTML document:</p>
<p class="image"><img alt="image" src="f0822-02.jpg"/></p>
<h5 class="h5"><a id="page_823"/><a id="ch17lev2sec11"/><strong>Drawing with SVG</strong></h5>
<p class="noindent">SVG uses tags to draw shapes. The shape tags include <span class="codesample"><strong>&lt;rect&gt;</strong></span>, <span class="codesample"><strong>&lt;polygon&gt;</strong></span>, <span class="codesample"><strong>&lt;ellipse&gt;</strong></span>, <span class="codesample"><strong>&lt;circle&gt;</strong></span>, <span class="codesample"><strong>&lt;text&gt;</strong></span>, and <span class="codesample"><strong>&lt;line&gt;</strong></span>. Attributes are used to configure the tags. Many settings can be applied to the shape via an attribute or a CSS style:</p>
<p class="image"><img alt="image" src="f0823-01.jpg"/></p>
<p class="image1"><img alt="image" src="f0823-02.jpg"/></p>
<p class="indent">Script can be added directly to an SVG document within a CDATA section:</p>
<p class="image"><img alt="image" src="f0823-03.jpg"/></p>
<p class="indent">In order to create an SVG element through JavaScript, the DOM functions, <span class="codesample">createElementNS(), setAttribute(),</span> and <span class="codesample">appendChild()</span> are used:</p>
<p class="image"><img alt="image" src="f0823-04.jpg"/></p>
<p class="noindent">You might recall the namespace DOM facilities from <a class="nounder" href="ch10.html#ch10">Chapter 10</a>. Here we see a practical use for them.</p>
<h5 class="h5"><a id="ch17lev2sec12"/><strong>SVG Interaction and Animation</strong></h5>
<p class="noindent">As mentioned before, hooking up events to SVG is quite trivial and requires the same skills as hooking up HTML DOM events. In addition, when performing the action, it is simple to <a id="page_824"/>modify the attributes of an SVG element and not have to worry about redrawing the entire page.</p>
<p class="image"><img alt="image" src="f0824-01.jpg"/></p>
<p class="indent">The <span class="codesample"><em>printCoords()</em></span> function is much simpler than the <span class="codesample"><strong>&lt;canvas&gt;</strong></span> version because the event contains the coordinates within the SVG document, along with the coordinates of the target element. The difference between these values results in the coordinates within the current element, and no other manipulations or calculations are required:</p>
<p class="image"><img alt="image" src="f0824-02.jpg"/></p>
<p class="noindent">Similarly, the <span class="codesample"><em>changeColor()</em></span> function is quite trivial. The <span class="codesample">fill</span> attribute needs to be updated to the new color. The shape to be modified is the target of the event, so no additional calculations are necessary:</p>
<p class="image"><img alt="image" src="f0824-03.jpg"/></p>
<p class="indent">In addition to easier interactivity, SVG also offers tags that provide animation. These tags are embedded within the object that they are animating:</p>
<p class="image"><img alt="image" src="f0824-04.jpg"/></p>
<p class="noindent">This will move the rectangle to the right 50 pixels. It will take place over three seconds and will stop after one iteration. It is possible to set <span class="codesample"><strong>repeatCount</strong></span> to “<span class="codesample">indefinite</span>” to run the animation continuously. The <span class="codesample"><strong>&lt;animateMotion&gt;</strong></span> and <span class="codesample"><strong>&lt;animateTransform&gt;</strong></span> tags are also used to animate other aspects of an SVG drawing.</p>
<p class="indent">SVG can also use the <span class="codesample">setTimeout()</span> or <span class="codesample">requestAnimationFrame()</span> schemes that we previously discussed in the canvas section. Once again, the animation redraw will only require the modification of the changed attribute and not redrawing the entire picture.</p>
<hr/>
<p class="online"><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/svg.html">http://javascriptref.com/3ed/ch17/svg.html</a></p>
<h4 class="h4"><a id="page_825"/><a id="ch17lev1sec5"/><strong>HTML5 Media Handling</strong></h4>
<p class="noindent">Two significant new features of HTML5 are the <span class="codesample"><strong>&lt;audio&gt;</strong></span> and <span class="codesample"><strong>&lt;video&gt;</strong></span> tags. These tags build audio and video media into the browser instead of necessitating the use of flash or another plug-in. The audio and video elements share many of the same properties and methods. The difference being, of course, that video is visual while audio is solely auditory.</p>
<h5 class="h5"><a id="ch17lev2sec13"/><strong>&lt;video&gt;</strong></h5>
<p class="noindent">To add video to a Web page, a <span class="codesample"><strong>&lt;video&gt;</strong></span> tag can be placed among the HTML. Generally <span class="codesample"><strong>&lt;source&gt;</strong></span> tags are added as children of the video element to indicate where the video is coming from. The <span class="codesample"><strong>&lt;source&gt;</strong></span> tag should specify the <span class="codesample"><strong>src</strong></span> as well as the <span class="codesample"><strong>type</strong></span>. The <span class="codesample"><strong>video</strong></span> element can have an unlimited number of <span class="codesample"><strong>&lt;source&gt;</strong></span> children. The browser will look at them in order and load the first one that is supported. After the <span class="codesample"><strong>&lt;source&gt;</strong></span> tags, a fallback can be specified that will only be loaded if the browser does not support the <span class="codesample"><strong>video</strong></span> element. In this example, the fallback is an error message, but it is also possible to put HTML to load a plug-in such as Flash here:</p>
<p class="image"><img alt="image" src="f0825-01.jpg"/></p>
<p class="indent">The <span class="codesample"><strong>source</strong></span> element’s properties are described in <a class="nounder" href="ch17.html#tab17-14">Table 17-14</a>.</p>
<p class="tabcap"><a id="tab17-14"/><strong>Table 17-14</strong> Properties of the HTMLSourceElement Object</p>
<p class="image"><img alt="image" src="t0825-01.jpg"/></p>
<p class="indent">If only one source is needed, such as in the case that all browsers support a single type in the future, the <span class="codesample"><strong>&lt;source&gt;</strong></span> elements are not necessary and the <span class="codesample"><strong>src</strong></span> attribute can be placed directly on the <span class="codesample"><strong>&lt;video&gt;</strong></span> tag:</p>
<p class="image"><img alt="image" src="f0825-02.jpg"/></p>
<p class="indent">The video element has an extensive API for controlling media through JavaScript. The <span class="codesample">controls</span> property can be set so that built-in controls will show up allowing the user to play and pause the video at their discretion. It is also possible to hide the controls and create your own. In this case, the <span class="codesample">play()</span> and <span class="codesample">pause()</span> methods can be used to implement those behaviors. By default, the playback will stop at the end of the data, but it is possible to set the <span class="codesample">loop</span> property to <span class="codesample">true</span> in order to play the video continuously.</p>
<p class="indent"><a id="page_826"/>Before a video has any data to display, an image can be shown in the area that the video will be displayed in. This image can be set via the <span class="codesample">poster</span> property:</p>
<p class="image"><img alt="image" src="f0826-01.jpg"/></p>
<p class="indent">An interesting property is the <span class="codesample">playbackRate</span>. This is set to a number where <span class="codesample">1</span> is normal speed. With this property, it is possible to speed up or slow down the media feed. It is possible to jump around the video timeline by setting the <span class="codesample">currentTime</span> property to a number indicating the current position of the video playback represented in seconds. When this property is updated, the video will move to the location specified:</p>
<p class="image"><img alt="image" src="f0826-02.jpg"/></p>
<p class="indent">The volume can be changed by directly modifying the <span class="codesample">volume</span> property. This should be set to a value between <span class="codesample">0</span> and <span class="codesample">1</span>, where <span class="codesample">0</span> is muted and <span class="codesample">1</span> is the loudest. It is also possible to set the <span class="codesample">muted</span> property to <span class="codesample">true</span> to mute the video directly:</p>
<p class="image"><img alt="image" src="f0826-03.jpg"/></p>
<p class="indent">There exist a number of properties that give you information about the video loading and playback status. The <span class="codesample">src</span> and <span class="codesample">currentSrc</span> point to the URL that is feeding the data to the video. The <span class="codesample">videoWidth</span> and <span class="codesample">videoHeight</span> indicate the dimensions of the actual video, whereas <span class="codesample">width</span> and <span class="codesample">height</span> indicate the dimensions of the <span class="codesample"><strong>video</strong></span> element on the page. The <span class="codesample">networkState</span> property is set to one of four values that indicate the state of the network fetch of the video. This property can be set to any of the following values:</p>
<p class="bullet"><strong>• <span class="codesample">HTMLMediaElement.NETWORK_EMPTY</span></strong> Indicates that the <span class="codesample">currentSrc</span> is not set</p>
<p class="bullet"><strong>• <span class="codesample">HTMLMediaElement.NETWORK_IDLE</span></strong> Indicates that resource fetching is possible but awaiting feedback from the user before fetching any more data</p>
<p class="bullet"><strong>• <span class="codesample">HTMLMediaElement.NETWORK_LOADING</span></strong> Indicates that data is currently being fetched</p>
<p class="bullet"><strong>• <span class="codesample">HTMLMediaElement.NETWORK_NO_SOURCE</span></strong> Indicates that the <span class="codesample">currentSrc</span> cannot be loaded</p>
<p class="noindent">Next, the <span class="codesample">readyState</span> property can be set to one of five values indicating the <span class="codesample">readyState</span> of the media load:</p>
<p class="bullet"><strong>• <span class="codesample">HTMLMediaElement.HAVE_NOTHING</span></strong> Indicates that no information about the video has been loaded</p>
<p class="bullet"><strong>• <span class="codesample">HTMLMediaElement.HAVE_METADATA</span></strong> Indicates that the metadata has been loaded, including <span class="codesample">duration</span>, <span class="codesample">videoWidth</span>, and <span class="codesample">videoHeight</span></p>
<p class="bullet"><a id="page_827"/><strong>• <span class="codesample">HTMLMediaElement.HAVE_CURRENT_DATA</span></strong> Indicates that there is data for the current position but not future frames</p>
<p class="bullet"><strong>• <span class="codesample">HTMLMediaElement.HAVE_FUTURE_DATA</span></strong> Indicates that there is data for the current position and the next frame but not enough to keep playing without rebuffering</p>
<p class="bullet"><strong>• <span class="codesample">HTMLMediaElement.HAVE_ENOUGH_DATA</span></strong> Indicates that there is enough data to play continuously through without rebuffering</p>
<p class="indenttop">There are a few <span class="codesample">TimeRange</span> objects that give range-of-time information. The first is <span class="codesample">buffered</span>, which indicates the time range that has been buffered. The <span class="codesample">seekable</span> property holds the range for the time that the user is able to seek to. The <span class="codesample">seeking</span> property contains a Boolean indicating that the media is currently seeking to a new position. Finally, <span class="codesample">played</span> holds the range of the video that has been played.</p>
<p class="indent">The following code, a rendering of which is shown in <a class="nounder" href="ch17.html#fig17-9">Figure 17-9</a>, gets all the relevant information about the video and displays it in a message on the page:</p>
<p class="image"><a id="fig17-9"/><img alt="image" src="f0828-01.jpg"/></p>
<p class="figcap"><strong>Figure 17-9</strong> HTML5 video demo rendering</p>
<p class="image"><img alt="image" src="f0827-01.jpg"/></p>
<hr/>
<p class="online"><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/video.html">http://javascriptref.com/3ed/ch17/video.html</a></p>
<p class="indent">There are a few properties that are specific to <strong>&lt;video&gt;</strong>. These are detailed in <a class="nounder" href="ch17.html#tab17-15">Table 17-15</a>.</p>
<p class="tabcap"><a id="tab17-15"/><strong>Table 17-15</strong> Properties of the Video Object<a id="page_828"/></p>
<p class="image"><img alt="image" src="t0828-01.jpg"/></p>
<p class="indent"><a id="page_829"/>The rest are applicable to both <span class="codesample"><strong>&lt;audio&gt;</strong></span> and <span class="codesample"><strong>&lt;video&gt;</strong></span> and can be seen in <a class="nounder" href="ch17.html#tab17-16">Table 17-16</a>.</p>
<p class="tabcap"><a id="tab17-16"/><strong>Table 17-16</strong> Properties of the Media Object</p>
<p class="imagea"><img alt="image" src="t0829-01.jpg"/></p>
<p class="image0"><img alt="image" src="t0829-02.jpg"/></p>
<p class="image0"><img alt="image" src="t0830-01.jpg"/></p>
<p class="image0"><img alt="image" src="t0830-02.jpg"/></p>
<p class="indent"><a id="page_830"/>Finally, the methods are all applicable to both <span class="codesample"><strong>&lt;video&gt;</strong></span> and <span class="codesample"><strong>&lt;audio&gt;</strong></span> and are listed in <a class="nounder" href="ch17.html#tab17-17">Table 17-17</a>.</p>
<p class="tabcap"><a id="tab17-17"/><strong>Table 17-17</strong> Methods of the Media Object</p>
<p class="image"><img alt="image" src="t0831-01.jpg"/></p>
<h5 class="h5"><a id="ch17lev2sec14"/><strong>&lt;audio&gt;</strong></h5>
<p class="noindent">As mentioned above, most of the properties that we described in regards to <span class="codesample"><strong>&lt;video&gt;</strong></span> also apply to <span class="codesample"><strong>&lt;audio&gt;</strong>. An audio</span> element is added to a page in the same manner as a <span class="codesample"><strong>video</strong></span> element using either <span class="codesample"><strong>&lt;source&gt;</strong></span> tags or the <span class="codesample"><strong>src</strong></span> attribute directly on the <span class="codesample"><strong>&lt;audio&gt;</strong></span> tag.</p>
<p class="image"><img alt="image" src="f0830-01.jpg"/></p>
<p class="indent"><a id="page_831"/>Audio can be controlled by the end user using the built-in controls, or it can be controlled via the API in the same manner as <span class="codesample"><strong>&lt;video&gt;</strong></span>. If trying to choose a media file to set as the <span class="codesample"><strong>src</strong></span>, it is possible to use the <span class="codesample">canPlayType(<em>type</em>)</span> method. After passing in a MIME type, the function will return the empty string (meaning that it is not supported), “<span class="codesample">maybe</span>”, or “<span class="codesample">probably</span>”. Though these aren’t the most confident answers, it gives some indication as to what is supported by the browser.</p>
<hr/>
<p class="online"><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/audio.html">http://javascriptref.com/3ed/ch17/audio.html</a></p>
<h5 class="h5"><a id="ch17lev2sec15"/><strong>Media Events</strong></h5>
<p class="noindent">In addition to the properties and methods of the media elements, many events can be handled for all phases of the media download and play. These events are detailed in <a class="nounder" href="ch17.html#tab17-18">Table 17-18</a>.</p>
<p class="imagea"><img alt="image" src="t0831-02.jpg"/></p>
<p class="image0"><img alt="image" src="t0832-01.jpg"/></p>
<p class="image0"><img alt="image" src="t0832-02.jpg"/></p>
<p class="tabcap"><a id="tab17-18"/><strong>Table 17-18</strong> Events of the Media Object</p>
<h4 class="h4"><a id="page_832"/><a id="ch17lev1sec6"/><strong>Plug-Ins</strong></h4>
<p class="noindent">Browser <em>plug-ins</em> are executable components that extend the browser’s capabilities in a particular way. When the browser encounters an embedded object of a type that it is not prepared to handle (for example, something that isn’t HTML or another Web file type), the browser might hand the content off to an appropriate plug-in. If no appropriate plug-in is installed, the user is given the option to install one (assuming the page is properly written). Plug-ins consist of executable code for displaying or otherwise processing a particular type of data. In this way, the browser is able to hand special types of data, for example, multimedia files, to plug-ins for processing.</p>
<p class="indent">Plug-ins are persistent in the browser in the sense that once installed, they remain there unless manually removed by the user. Most browsers come with many plug-ins already installed, so you may have used them without even knowing it. Plug-ins were introduced in Netscape 2 but are supported, at least HTML–syntax-wise, by all major browsers, including Firefox, Safari, Chrome, Opera, and Internet Explorer. However, the actual component in the case of Internet Explorer is not a plug-in but instead an ActiveX control discussed later in the chapter.</p>
<h5 class="h5"><a id="page_833"/><a id="ch17lev2sec16"/><strong>Embedding Content for Plug-Ins</strong></h5>
<p class="noindent">Although not initially a part of any HTML specification, the <span class="codesample"><strong>&lt;embed&gt;</strong></span> tag is now specified under HTML5 and is the most common way to add plug-in–based content to a Web page. As an example, a Macromedia Flash file might be embedded as follows:</p>
<p class="image"><img alt="image" src="f0833-01.jpg"/></p>
<p class="noindent">The result of loading a page with this markup is shown here:</p>
<p class="image"><img alt="image" src="f0833-02.jpg"/></p>
<p class="indent">The most important attributes of the <span class="codesample"><strong>&lt;embed&gt;</strong></span> tag are <span class="codesample"><strong>src</strong></span>, which gives the URL of the embedded object, and the dimensions <span class="codesample"><strong>height</strong></span> and <span class="codesample"><strong>width</strong></span> to define the space that the plug-in content may consume. The HTML5 specification also defines <span class="codesample"><strong>type</strong></span>, which is the MIME type used to trigger the associated plug-in. This really should be done via the correct header set on the HTTP response or by the file extension, but if you need it the attribute is there.</p>
<p class="indent">Access to the common attributes is as like any other DOM element, and the corresponding properties in the case of plug-ins are identical (<span class="codesample">height</span>, <span class="codesample">width</span>, <span class="codesample">src</span>, and <span class="codesample">type</span>). Accessing the embedded object of interest can be performed directly using methods such as <span class="codesample">document.getElementById</span> (“<span class="codesample">demo</span>”), but you can also rely on the fact that, as an older technology, you can use collections such as <span class="codesample">document.embeds[]</span> or <span class="codesample">document.plugins[]</span>. We’ll see the use of these in an upcoming section.</p>
<p class="indent">There may be quite a number of other attributes on an <span class="codesample"><strong>&lt;embed&gt;</strong></span> tag not defined in any specification. Some of these attributes are general to the plug-in architecture. For example, <span class="codesample"><strong>pluginspage</strong></span> indicates to the browser where the required plug-in is to be found if it is not installed in the browser. Plug-in vendors typically make available the embedding syntax, so check their site for the value of <span class="codesample"><strong>pluginspage</strong></span>. Other attributes may be specific to the type of embedded content; for example, we show the <span class="codesample"><strong>loop</strong></span> attribute, which can control the play behavior of the SWF file. There may be numerous attributes per embedded content type, so it is best to check the documentation of whatever you are embedding carefully for the allowed options.</p>
<p class="indent">Traditionally, the HTML specification focused on the <span class="codesample"><strong>&lt;object&gt;</strong></span> tag as the more official way to include embedded objects of any kind in your pages; however, <span class="codesample"><strong>&lt;embed&gt;</strong></span> continues to be supported by new browsers, and it is widely used by developers, so it is unlikely that <span class="codesample"><strong>&lt;object&gt;</strong></span> will completely supplant <span class="codesample"><strong>&lt;embed&gt;</strong></span>, at least any time in the near future. Nevertheless, <span class="codesample"><strong>&lt;object&gt;</strong></span> and <span class="codesample"><strong>&lt;embed&gt;</strong></span> are very often used together in order to maximize client compatibility. This technique is illustrated in the section entitled “ActiveX” later in this chapter.</p>
<h5 class="h5"><a id="ch17lev2sec17"/><strong>MIME Types</strong></h5>
<p class="noindent">So how does the browser know what kind of data is appropriate for each plug-in? The answer lies in Multipurpose Internet Mail Extension (MIME) types. <em>MIME types</em> are short <a id="page_834"/>strings of the form <span class="codesample"><em>mediatype/subtype</em>,</span> where the <span class="codesample"><em>mediatype</em></span> describes the general nature of the data and the <span class="codesample"><em>subtype</em></span> describes it more specifically. For example, GIF images have the type <span class="codesample"><em>image/gif</em>,</span> which indicates that the data is an image and that its specific format is GIF (Graphics Interchange Format). In contrast, CSS files have the type <span class="codesample"><em>text/css</em>,</span> which indicates that the file is composed of plain text adhering to CSS specifications. The MIME major media types are <span class="codesample"><em>application</em></span> (proprietary data format used by some applications), <span class="codesample"><em>audio</em></span>, <span class="codesample"><em>image</em></span>, <span class="codesample"><em>message</em></span>, <span class="codesample"><em>model</em></span>, <span class="codesample"><em>multipart</em></span>, <span class="codesample"><em>text</em></span>, and <span class="codesample"><em>video</em></span>.</p>
<p class="indent">Each media type is associated with at most one handler in the browser. Common Web media such as XHTML, CSS, plain text, and images are handled by the browser itself. Other media, such as MPEG video and Macromedia Flash, are associated with the appropriate plug-in (if it is installed). Keep in mind that a plug-in can handle multiple MIME types (for example, different types of video), but that each MIME type is associated with at most one plug-in. If one type were associated with more than one plug-in, the browser would have to find some way to arbitrate which component actually receives the data.</p>
<h6 class="h6"><strong>Detecting Support for MIME Types</strong></h6>
<p class="noindent">Most browsers provide an easy way to examine the ability of the browser to handle particular MIME types. The <span class="codesample">mimeTypes[]</span> array found in the <span class="codesample">Navigator</span> object holds an array of <span class="codesample">MimeType</span> objects. Some interesting properties of this object are shown in <a class="nounder" href="ch17.html#tab17-19">Table 17-19</a>.</p>
<p class="tabcap"><a id="tab17-19"/><strong>Table 17-19</strong> Properties of the MimeType Object</p>
<p class="image"><img alt="image" src="t0834-01.jpg"/></p>
<p class="indent">The browser hands embedded objects off to plug-ins according to the data that makes up each of these objects. A good way to think about the process is that the browser looks up MIME types and filename suffixes in the <span class="codesample">mimeTypes[]</span> array to find the <span class="codesample">enabledPlugin</span> reference to the appropriate plug-in. The programmer can therefore use the <span class="codesample">mimeTypes</span> array to check whether the browser will be able to handle a particular kind of data.</p>
<p class="indent">Before delving into this process, it might be insightful to see what MIME types your browser supports. The following code prints out the contents of the <span class="codesample">mimeTypes[]</span> array:</p>
<p class="image"><img alt="image" src="f0834-01.jpg"/></p>
<p class="noindent"><a id="page_835"/>Part of the result is shown in <a class="nounder" href="ch17.html#fig17-10">Figure 17-10</a>.</p>
<p class="image1"><a id="fig17-10"/><img alt="image" src="f0835-01.jpg"/></p>
<p class="figcap"><strong>Figure 17-10</strong> MIME types collection example output</p>
<p class="indent">In some browsers, notably the Mozilla-based browsers, you may access similar plug-in information by typing <span class="codesample">about:plugins</span> in the address bar of the browser. See <a class="nounder" href="ch17.html#fig17-11">Figure 17-11</a> for an example.</p>
<p class="image1"><a id="fig17-11"/><img alt="image" src="f0836-01.jpg"/></p>
<p class="figcap"><strong>Figure 17-11</strong> about:plugins Example Output</p>
<p class="indent"><a id="page_836"/>To detect support for a particular data type, you first access the <span class="codesample">mimeTypes[]</span> array by the MIME type string in which you are interested. If a <span class="codesample">MimeType</span> object exists for the desired type, you then make sure that the plug-in is available by checking the <span class="codesample">MimeType</span> object’s <span class="codesample">enabledPlugin</span> property. The concept is illustrated by the following code:</p>
<p class="image"><img alt="image" src="f0836-02.jpg"/></p>
<p class="noindent"><a id="page_837"/>If the user’s browser has the <span class="codesample">mimeTypes[]</span> array, supports MPEG video (<em>video/mpeg</em>), and the plug-in is enabled, an embedded MPEG video file is written to the document. If these conditions are not fulfilled, then a simple image is written to the page. This MIME type detection technique is used when you care only whether a browser supports a particular kind of data. It gives you no guarantee about the particular plug-in that will handle it. To harness some of the more advanced capabilities that a plug-in may provide, you often need to know if a specific vendor’s plug-in is in use. This requires a different approach.</p>
<h5 class="h5"><a id="ch17lev2sec18"/><strong>Detecting Specific Plug-Ins</strong></h5>
<p class="noindent">Each plug-in installed in the browser should create an entry in the <span class="codesample">plugins[]</span> array of the <span class="codesample">Navigator</span> object when a browser supports this type of technology. Each entry in this array is a <span class="codesample">Plugin</span> object containing information about the specific vendor and version of the component installed. Some interesting properties of the <span class="codesample">Plugin</span> object are listed in <a class="nounder" href="ch17.html#tab17-20">Table 17-20</a>.</p>
<p class="tabcap"><a id="tab17-20"/><strong>Table 17-20</strong> Interesting Properties of the Plugin Object</p>
<p class="image"><img alt="image" src="t0837-01.jpg"/></p>
<p class="indent">Each <span class="codesample">Plugin</span> object is an array of the <span class="codesample">MimeType</span> objects that it supports (hence its <span class="codesample">length</span> property). You can visualize the <span class="codesample">plugins[]</span> and <span class="codesample">mimeTypes[]</span> arrays as being cross-connected. Each element in <span class="codesample">plugins[]</span> is an array containing references to one or more elements in <span class="codesample">mimeTypes[]</span>. Each element in <span class="codesample">mimeTypes[]</span> is an object referred to by exactly one element in <span class="codesample">plugins[]</span>, the element referred to by the <span class="codesample">MimeType’s</span> <span class="codesample">pluginEnabled</span> reference.</p>
<p class="indent">You can refer to the individual <span class="codesample">MimeType</span> objects in a <span class="codesample">Plugin</span> object by using double-array notation:</p>
<p class="image"><img alt="image" src="f0837-01.jpg"/></p>
<p class="noindent">This example references the third <span class="codesample">MimeType</span> object supported by the first plug-in.</p>
<p class="indent">More useful is to index the plug-ins by name. For example, to write all of the MIME types supported by the Flash plug-in (if it exists!), you might write the following:</p>
<p class="image"><img alt="image" src="f0837-02.jpg"/></p>
<p class="indent">Of course, as with all things plug-in related, you need to read vendor documentation very carefully in order to determine the <em>exact</em> name of the particular plug-in that you are interested in.</p>
<p class="indent"><a id="page_838"/>To illustrate the composition of the <span class="codesample">Plugin</span> object more clearly, the following code prints out the contents of the entire <span class="codesample">plugins[]</span> array:</p>
<p class="image"><img alt="image" src="f0838-01.jpg"/></p>
<p class="noindent">The results are shown in <a class="nounder" href="ch17.html#fig17-12">Figure 17-12</a>.</p>
<p class="image1"><a id="fig17-12"/><img alt="image" src="f0838-02.jpg"/></p>
<p class="figcap"><strong>Figure 17-12</strong> Output of Plugins list</p>
<h6 class="h6"><a id="page_839"/><strong>Dealing with Internet Explorer</strong></h6>
<p class="noindent">One thing to be particularly conscious of is that Internet Explorer defines a faux <span class="codesample">plugins[]</span> array as a property of <span class="codesample">Navigator</span>. It does so in order to prevent poorly written Netscape-specific scripts from throwing errors while they probe for plug-ins. Under Internet Explorer, you have some reference to plug-in related data through the <span class="codesample">document.embeds[]</span> collection. However, probing for MIME types and other functions is not supported, since Explorer actually uses ActiveX controls to achieve the function of plug-ins included via an <span class="codesample"><strong>&lt;embed&gt;</strong></span> tag. For more information on using JavaScript with ActiveX, see the section entitled “ActiveX” later in this chapter. For now, simply consider that to rely solely on information from <span class="codesample">navigator.plugins[]</span> without first doing some browser detection can have some odd or even disastrous consequences.</p>
<h5 class="h5"><a id="ch17lev2sec19"/><strong>Interacting with Plug-Ins</strong></h5>
<p class="noindent">By now, you might be wondering why one would want to detect whether a specific plug-in will be handling a particular MIME type. The reason is that it is possible to use JavaScript to interact with them. In other words, plug-ins can implement a public interface through which JavaScript can interact with them. This capability is most commonly used by multimedia plug-ins to provide JavaScript with fine-grained control over how video and audio are played. For example, plug-ins often make methods available to start, stop, and rewind content, as well as to control volume, quality, and size settings. The developer can then present the user with form fields that control the behavior of the plug-in through JavaScript.</p>
<p class="indent">This capability works in the reverse direction as well. Embedded objects can invoke JavaScript in the browser to control navigation or to manipulate the content of the page. The more advanced aspects of this technology are beyond the scope of this book, but common aspects include functions that plug-ins are programmed to invoke when a particular event occurs. Like a JavaScript event handler, the plug-in will attempt to invoke a function with a specific name at a well-defined time, such as when the user halts playback of a multimedia file, for example. To prevent namespace collisions with other objects in the page, these methods are typically prefixed with the <span class="codesample"><strong>name</strong></span> or <span class="codesample"><strong>id</strong></span> attribute of the <span class="codesample"><strong>&lt;object&gt;</strong></span> or <span class="codesample"><strong>&lt;embed&gt;</strong></span> tag of the object instance.</p>
<p class="indent">As with applets, there remains the issue of how the JavaScript developer knows which methods the plug-in provides and invokes. The primary source for this information is documentation from the plug-in vendor, but be warned: these interfaces are highly specific to vendor, version, and platform.</p>
<p class="indent">We now have most of the preliminary information required in order to detect and interact safely with plug-ins. There is, however, one final aspect of defensive programming to cover before jumping into the interaction itself.</p>
<h6 class="h6"><strong>Refreshing the Plug-Ins Array</strong></h6>
<p class="noindent">Suppose you have written some custom JavaScript to harness the capabilities provided by a specific plug-in. When users visit your page without the plug-in, they are prompted to install it because you have included the proper <span class="codesample"><strong>pluginspage</strong></span> attribute in your <span class="codesample"><strong>&lt;embed&gt;</strong></span> tag. Unfortunately, if a user visits your page without the plug-in, agrees to download and install it, and then returns to your page, your JavaScript will not detect that the browser has the required plug-in. The reason is that the <span class="codesample">plugins[]</span> array needs to be refreshed whenever a new plug-in is installed (a browser restart will work as well).</p>
<p class="indent"><a id="page_840"/>Refreshing the <span class="codesample">plugins[]</span> array is as simple as invoking its <span class="codesample">refresh()</span> method. Doing so causes the browser to check for newly installed plug-ins and to reflect the changes in the <span class="codesample">plugins[]</span> and <span class="codesample">mimeTypes[]</span> arrays. This method takes a Boolean argument indicating whether the browser should reload any current documents containing an <span class="codesample"><strong>&lt;embed&gt;</strong></span>. If you supply <span class="codesample">true</span>, the browser causes any documents (and frames) that might be able to take advantage of the new plug-in to reload. If <span class="codesample">false</span> is passed to the method, the <span class="codesample">plugins[]</span> array is updated, but no documents are reloaded. A typical example of the method’s use is found here:</p>
<p class="image"><img alt="image" src="f0840-01.jpg"/></p>
<p class="noindent">Of course, this should be presented only to users of plug-in–supporting browsers in the first place.</p>
<h6 class="h6"><strong>Interacting with a Specific Plug-In</strong></h6>
<p class="noindent">To illustrate interaction with plug-ins, we show a simple example using a Flash file. First, we ensure that the flash plug-in exists. If not, an error alert is displayed. If flash does exist, the control buttons are hooked up to control the flow of the flash movie.</p>
<p class="indent">The methods we will use in our simple example are <span class="codesample">GotoFrame()</span>, <span class="codesample">IsPlaying()</span>, <span class="codesample">Play()</span>, <span class="codesample">Rewind()</span>, <span class="codesample">StopPlay()</span>, <span class="codesample">TotalFrames()</span>, and <span class="codesample">Zoom()</span>. The following example controls a simple Flash file extolling the wonders of JavaScript:</p>
<p class="image"><img alt="image" src="f0840-02.jpg"/></p>
<p class="image"><a id="page_841"/><img alt="image" src="f0840-03.jpg"/></p>
<p class="image"><img alt="image" src="f0840-04.jpg"/></p>
<hr/>
<p class="online"><a id="page_842"/><strong>ONLINE</strong> <a class="nounder" href="http://www.www.javascriptref.com/3ed/ch17/scriptToFlash.html">http://www.javascriptref.com/3ed/ch17/scriptToFlash.html</a></p>
<p class="indent">The example—stopped in the middle of playback and zoomed in—is shown in <a class="nounder" href="ch17.html#fig17-13">Figure 17-13</a>.</p>
<p class="image1"><a id="fig17-13"/><img alt="image" src="f0842-04.jpg"/></p>
<p class="figcap"><strong>Figure 17-13</strong> Controlling an SWF file from JavaScript</p>
<p class="indent">There exist far more powerful capabilities than the previous example demonstrates. One particularly useful aspect of Flash is that embedded files can issue commands using the <span class="codesample">ExternalInterface</span> library that can be “caught” with JavaScript by defining an appropriately named function. An embedded Flash file can call the following:</p>
<p class="image"><img alt="image" src="f0842-01.jpg"/></p>
<p class="noindent">Flash:</p>
<p class="image"><img alt="image" src="f0842-02.jpg"/></p>
<p class="noindent">JavaScript:</p>
<p class="image"><img alt="image" src="f0842-03.jpg"/></p>
<p class="noindent">This will cause the Flash file to cross over into browser territory to invoke the <span class="codesample"><em>functionName</em> ()</span> method if one exists. Similarly, the JavaScript can call a function <a id="page_843"/>in the SWF if it was initialized by the Flash file. In ActionScript, the <span class="codesample">ExternalInterface.addCallback(<em>functionName, function</em>)</span> method is used to set up the accessibility, where the <span class="codesample"><em>functionName</em></span> is the name that is called from JavaScript and <span class="codesample"><em>function</em></span> is a reference to the function that should be invoked. It is important to note that an error will be thrown if <span class="codesample">ExternalInterface</span> calls are attempted before the Flash file has completed loading. Either wait until <span class="codesample">window.onload</span> occurs or use <span class="codesample">ExternalInterface.call</span> to indicate that the Flash load has completed.</p>
<p class="noindent">Flash/ActionScript:</p>
<p class="image"><img alt="image" src="f0843-01.jpg"/></p>
<p class="noindent">JavaScript:</p>
<p class="image"><img alt="image" src="f0843-02.jpg"/></p>
<p class="indent">The following examples, also shown in <a class="nounder" href="ch17.html#fig17-14">Figure 17-14</a>, illustrate this usage by sending messages back and forth between Flash and JavaScript.</p>
<p class="image1"><a id="fig17-14"/><img alt="image" src="f0845-01.jpg"/></p>
<p class="figcap"><strong>Figure 17-14</strong> Communication from Flash to JavaScript and back</p>
<p class="noindent">Flash/ActionScript File:</p>
<p class="image"><img alt="image" src="f0843-03.jpg"/></p>
<p class="noindent">HTML File:</p>
<p class="image"><img alt="image" src="f0843-04.jpg"/></p>
<p class="image"><a id="page_844"/><img alt="image" src="f0843-05.jpg"/></p>
<hr/>
<p class="online"><strong>ONLINE</strong> <a class="nounder" href="http://www.www.javascriptref.com/3ed/ch17/externalInterface.html">http://www.javascriptref.com/3ed/ch17/externalInterface.html</a></p>
<h4 class="h4"><a id="page_845"/><a id="ch17lev1sec7"/><strong>ActiveX</strong></h4>
<p class="noindent">ActiveX is a Microsoft component object technology enabling Windows programs to load and use other programs or objects at runtime. ActiveX controls are basically subprograms launched by the browser that can interact with page content. For example, if a <span class="codesample"><strong>&lt;textarea&gt;</strong></span> provided insufficient editing capabilities for a particular task, the page author might include an ActiveX control that provides an editor interface similar to that of Microsoft Word.</p>
<p class="indent">While, on the surface, ActiveX controls might seem a lot like plug-in or Java applet technology, there are important differences, most notably that the security posture of ActiveX controls was initially much looser than other technologies. Second, because ActiveX controls are executable code, they are built for a specific operating system and platform. This means that they are minimally supported outside of Internet Explorer and not at all outside of Windows.</p>
<h5 class="h5"><a id="ch17lev2sec20"/><strong>Including ActiveX Controls</strong></h5>
<p class="noindent">An ActiveX control is embedded in the page using an <span class="codesample"><strong>&lt;object&gt;</strong></span> tag with the <span class="codesample"><strong>classid</strong></span> attribute specifying the GUID (Globally Unique Identifier) of the ActiveX control you wish to instantiate. Parameters are passed using <span class="codesample"><strong>&lt;param&gt;</strong></span> elements, and anything included between the <span class="codesample"><strong>&lt;object&gt;</strong></span>‘s opening and closing tags is processed by non- <span class="codesample"><strong>&lt;object&gt;</strong></span>-aware browsers; for example, the following defines an embedded Flash file for use with an ActiveX control:</p>
<p class="image"><img alt="image" src="f0845-02.jpg"/></p>
<p class="noindent"><a id="page_846"/>In general, ActiveX controls have <span class="codesample"><strong>classid</strong></span> attributes beginning with “<span class="codesample">clsid:</span>.” We’ll see another possibility later where the <strong><span class="codesample">classid</span></strong> began with “<span class="codesample">java</span>:.” In general, the <span class="codesample"><strong>classid</strong></span> attribute specifies the unique identifier of the control for which the data is intended. The <span class="codesample"><strong>classid</strong></span> value for each ActiveX control is published by the vendor, but it is also commonly inserted by Web editor tools automatically. You’ll notice that within the tag we have some other content, which serves as the fallback content in case the object isn’t supported.</p>
<h6 class="h6"><strong>Cross-Browser Inclusion of Embedded Objects</strong></h6>
<p class="noindent">By far, the best way to ensure the cross-browser compatibility of your pages is to use a combination of ActiveX control syntax and other browser <span class="codesample"><strong>&lt;object&gt;</strong></span> or <span class="codesample"><strong>&lt;embed&gt;</strong></span> syntax. To accomplish this, use an <span class="codesample"><strong>&lt;object&gt;</strong></span> intended for Internet Explorer/Windows ActiveX controls and then an <span class="codesample"><strong>&lt;embed&gt;</strong></span> tag for other browsers. The technique is illustrated in the following example:</p>
<p class="image"><img alt="image" src="f0846-01.jpg"/></p>
<p class="noindent">Browsers that do not understand <span class="codesample"><strong>&lt;object&gt;</strong></span> will see the <span class="codesample"><strong>&lt;embed&gt;</strong></span>, whereas browsers capable of processing <span class="codesample"><strong>&lt;object&gt;</strong></span> will ignore the enclosed <span class="codesample"><strong>&lt;embed&gt;</strong></span>. We can make most other browsers recognize <span class="codesample"><strong>&lt;object&gt;</strong></span> for plug-ins, too. Unfortunately, Internet Explorer may try to interpret that as well, so we can use some conditional comments to mask it. This simple example shows how that might be accomplished:</p>
<p class="image"><img alt="image" src="f0846-02.jpg"/></p>
<p class="indent"><a id="page_847"/>Clearly, it is a good idea to think about all of the things that may go wrong and write your markup and JavaScript to address problems. In this sense, the <span class="codesample"><strong>&lt;embed&gt;</strong></span> syntax might actually be the better way to go. The details of the embedding controls, such as Flash movies and media, clearly evolve over time, so readers are warned to look online for the latest information. (At the time of this edition’s publication, <span class="codesample">SWFObject</span>—see <a class="nounder" href="http://www.code.google.com/p/swfobject/">http:// code.google.com/p/swfobject/</a>—was considered the most definitive way to handle insertion of Flash files in Web pages.)</p>
<h5 class="h5"><a id="ch17lev2sec21"/><strong>Interacting with ActiveX Controls</strong></h5>
<p class="noindent">JavaScript can be used to interact with ActiveX controls in a manner quite similar to plug-ins. A control is accessible under the <span class="codesample">Document</span> object according to the <span class="codesample"><strong>id</strong></span> of the <span class="codesample"><strong>&lt;object&gt;</strong></span> that included it. If the required control isn’t available, Internet Explorer should install it (subject to user confirmation) and then make it available for use.</p>
<hr/>
<p class="note"><strong>NOTE</strong> You may have to include the <span class="codesample"><strong>mayscript</strong></span> attribute in the <span class="codesample"><strong>&lt;object&gt;</strong></span> to enable callback functions.</p>
<p class="indent">Any methods exposed by the control are callable from JavaScript in the way applet or plug-in functionality is called. Simply invoke the appropriate function of the <span class="codesample"><strong>&lt;object&gt;</strong></span> in question. To invoke the <span class="codesample">Play()</span> method of the control in the previous example, you’d write the following:</p>
<p class="image"><img alt="image" src="f0847-01.jpg"/></p>
<p class="indent">As a quick demonstration, we recast the previous example so it works in Internet Explorer browsers as well as other browsers:</p>
<p class="image"><img alt="image" src="f0847-02.jpg"/></p>
<p class="image"><img alt="image" src="f0847-03.jpg"/></p>
<p class="image"><img alt="image" src="f0847-04.jpg"/><a id="page_848"/></p>
<hr/>
<p class="online"><a id="page_849"/><strong>ONLINE</strong> <a class="nounder" href="http://www.www.javascriptref.com/3ed/ch17/scriptToActiveX.html">http://www.javascriptref.com/3ed/ch17/scriptToActiveX.html</a></p>
<p class="indent">You might wonder if ActiveX controls can do everything plug-ins can. The answer is yes, they can, and maybe even a bit more. For example, data handled by ActiveX controls can take full advantage of callback functions, so everything that is possible with a plug-in is possible with ActiveX. The <span class="codesample">ExternalInterface</span> calls that we saw in the plugins example would work exactly the same with ActiveX.</p>
<hr/>
<p class="note"><strong>NOTE</strong> Interestingly, support for ActiveX in VBScript seems to be more capable than in JavaScript. This is most likely a result of the fact that it is a Microsoft technology. In fact, you may notice that some scripts that robustly handle older Internet Explorer versions may actually employ VBScript as well as JavaScript.</p>
<h4 class="h4"><a id="ch17lev1sec8"/><strong>Java Applets</strong></h4>
<p class="noindent">Many think that JavaScript is a boiled-down form of Java because of the similarity in their names. As we know from the history of JavaScript, it was originally called “LiveScript,” which suggests the mistake in drawing such a conclusion. While Java and JavaScript both are object-oriented languages, are commonly used on the Web, and have syntaxes that resemble the syntax of C, they are actually very different languages. Java is a class-based, object-oriented language, whereas JavaScript is prototype based. Java is strongly typed, whereas JavaScript is weakly typed. Java is compiled into platform-independent bytecode before execution, while JavaScript source code is generally interpreted directly by the browser.</p>
<p class="indent">Yet, interestingly, the inherent promise of Java applets seems to have faltered. The idea was to bring a cross-platform development environment with security and performance to a diverse device world, but this has been met now by JavaScript as opposed to Java. Java applets continue to live on and so we take a few pages to delve into them and how they interact with JavaScript, but given the current trends their future looks somewhat dim.</p>
<h5 class="h5"><a id="ch17lev2sec22"/><strong>Including Applets</strong></h5>
<p class="noindent">Before delving into the details of applet interaction, a brief review of how to include applets in your pages is in order. Traditionally, applets are included with the <span class="codesample"><strong>&lt;applet&gt;</strong></span> tag. The tag’s <span class="codesample"><strong>code</strong></span> attribute is then set to the URL of the .class file containing the applet, and the <span class="codesample"><strong>height</strong></span> and <span class="codesample"><strong>width</strong></span> attributes indicate the shape of the rectangle to which the applet’s input and output are confined; for example:</p>
<p class="image"><img alt="image" src="f0849-01.jpg"/></p>
<p class="noindent">Note how the <span class="codesample"><strong>&lt;applet&gt;</strong></span> tag’s <span class="codesample"><strong>name</strong></span> attribute (as well as <span class="codesample"><strong>id</strong></span> attribute) is also set. Doing so assigns the applet a convenient handle that JavaScript can use to access its internals.</p>
<p class="indent">Although the use of <span class="codesample"><strong>&lt;applet&gt;</strong></span> is widespread, it was deprecated initially under HTML4. More appropriate is the <span class="codesample"><strong>&lt;object&gt;</strong></span> tag. It has a similar syntax:</p>
<p class="image"><img alt="image" src="f0849-02.jpg"/></p>
<hr/>
<p class="note"><a id="page_850"/><strong>NOTE</strong> Sadly, problems with the use of the <span class="codesample"><strong>&lt;object&gt;</strong></span> syntax for including applets, the least of which is lack of support in older browsers, still arise. We will use the <span class="codesample"><strong>&lt;applet&gt;</strong></span> syntax, but you should be aware that it is preferable standards-wise to use <span class="codesample"><strong>&lt;object&gt;</strong></span> whenever possible.</p>
<p class="indent">Initial parameters can be included inside the <span class="codesample"><strong>&lt;applet&gt;</strong></span> or <span class="codesample"><strong>&lt;object&gt;</strong></span> tag using the <span class="codesample"><strong>&lt;param&gt;</strong></span> tag, as shown here:</p>
<p class="image"><img alt="image" src="f0850-01.jpg"/></p>
<h5 class="h5"><a id="ch17lev2sec23"/><strong>Java Detection</strong></h5>
<p class="noindent">Before attempting to manipulate an applet from JavaScript, you must first determine whether the user’s browser is Java-enabled. Although the contents of an <span class="codesample"><strong>&lt;applet&gt;</strong></span> tag are displayed to the user whenever Java is turned off or unavailable, you still need to write your JavaScript so that you do not try to interact with an applet that is not running.</p>
<p class="indent">The <span class="codesample">javaEnabled()</span> method of the <span class="codesample">Navigator</span> object returns a Boolean indicating whether the user has Java enabled. This method was added in some of the earliest browsers that support JavaScript interaction with Java applets. Using a simple <span class="codesample">if</span> statement with this method should provide the most basic Java detection, as shown here:</p>
<p class="image"><img alt="image" src="f0850-02.jpg"/></p>
<p class="noindent">Once support for Java is determined, JavaScript can be used to interact with included applets.</p>
<h5 class="h5"><a id="ch17lev2sec24"/><strong>Accessing Applets in JavaScript</strong></h5>
<p class="noindent">The ability to communicate with applets originated with a Netscape technology called LiveConnect. This technology allows JavaScript, Java, and plug-ins to interact in a coherent manner and automatically handles type conversion of data to a form appropriate to each. Microsoft implemented the same capabilities in Internet Explorer, though not under the name LiveConnect. The low-level details of how embedded objects and JavaScript interact are somewhat complicated, unique to each browser, and even vary between different versions of the same browser. The important thing is that, no matter what it is called, the capability exists in most browsers, though often with quirks or even security limitations.</p>
<p class="indent">Applets can be accessed through the <span class="codesample">applets[]</span> array of the <span class="codesample">Document</span> object or directly through <span class="codesample">Document</span> using the applet’s name. Consider the following HTML:</p>
<p class="image"><img alt="image" src="f0850-03.jpg"/></p>
<p class="noindent"><a id="page_851"/>Assuming that this applet is the first to be defined in the document, it can be accessed in all of the following ways, with the last being preferred:</p>
<p class="image"><img alt="image" src="f0851-01.jpg"/></p>
<p class="indent">The relevant aspect to the JavaScript-Java communication discussion is the fact that all properties and methods of the applet’s class that are declared <span class="codesample">public</span> are also available through the <span class="codesample">Applet</span> object. Consider the following Java class definition for the previous <span class="codesample"><em>myhelloworld</em></span> example. The output (when embedded as before) is shown here:</p>
<p class="image"><img alt="image" src="f0851-02.jpg"/></p>
<p class="image"><img alt="image" src="f0851-03.jpg"/></p>
<p class="indent">Now comes the interesting part. Because the <span class="codesample"><em>setMessage()</em></span> method of the <span class="codesample"><em>myhelloworld</em></span> class is declared <span class="codesample">public</span>, it is made available in the appropriate <span class="codesample">Applet</span> object. We can invoke it in JavaScript as follows:</p>
<p class="image1"><img alt="image" src="f0851-04.jpg"/></p>
<p class="indent">Before proceeding further with this example, it is very important to note that applets often require a significant amount of load time. Not only must the browser download the required code, but it also has to start the Java virtual machine and walk the applet through several initialization phases in preparation for execution. For this reason, it is never a good idea to access an applet with JavaScript before making sure that it has loaded. The following simple example shows a very basic JavaScript-to-Java interaction:</p>
<p class="image"><img alt="image" src="f0851-05.jpg"/></p>
<p class="image"><img alt="image" src="f0851-06.jpg"/></p>
<hr/>
<p class="online"><a id="page_852"/><strong>ONLINE</strong> <a class="nounder" href="http://www.javascriptref.com/3ed/ch17/javascriptjava.html">http://javascriptref.com/3ed/ch17/javascriptjava.html</a></p>
<p class="noindent">The output of this script after changing the message is shown in <a class="nounder" href="ch17.html#fig17-15">Figure 17-15</a>.</p>
<p class="image"><a id="fig17-15"/><img alt="image" src="f0852-01.jpg"/></p>
<p class="figcap"><strong>Figure 17-15</strong> Changing a Java applet from JavaScript</p>
<p class="indent"><a id="page_853"/>There are tremendous possibilities with this capability. If class instance variables are declared <span class="codesample">public</span>, they can be set or retrieved as you would expect:</p>
<p class="image"><img alt="image" src="f0853-01.jpg"/></p>
<p class="noindent">Inherited variables are, of course, also available. So if you design your applet right and the browser allows for it based on security and domain conditions being right, you should be able to control an applet from JavaScript, but can you do it the other way around?</p>
<h5 class="h5"><a id="ch17lev2sec25"/><strong>Accessing JavaScript with Applets</strong></h5>
<p class="noindent">Although it may come as a surprise, it is possible for Java applets to drive JavaScript. Some browsers are capable of using the <span class="codesample">netscape</span> Java package, which defines a family of class libraries for JavaScript interaction. Though we should note this Java-JavaScript integration appears to be on a phase-out path, so we don’t expect it to be widely supported in the future. Regardless of its murky future, we note that the <span class="codesample">JSObject</span> class (<span class="codesample">netscape. javascript.JSObject</span>) allows an applet to retrieve and manipulate JavaScript objects in the current page. In addition, it affords an applet the ability to execute arbitrary JavaScript in the browser window as if it were a part of the page.</p>
<p class="indent">On the XHTML side of things, all that is required to enable this functionality is the addition of the <span class="codesample"><strong>mayscript</strong></span> attribute to the <span class="codesample"><strong>&lt;applet&gt;</strong></span> tag in question. The <span class="codesample"><strong>mayscript</strong></span> attribute is a nonstandard security feature used to prevent malicious applets from modifying the documents in which they are contained. Omitting this attribute (theoretically) prevents the applet from crossing over into “browser space,” though enforcement by browsers is spotty.</p>
<p class="indent">While this is a powerful capability, Java-driven JavaScript is rarely used in practice. Details about these classes can be found in Java documentation online.</p>
<h4 class="h4"><a id="ch17lev1sec9"/><strong>The Uncertain Future</strong></h4>
<p class="noindent">Recently, there were great shockwaves in the browser community because Steve Jobs banned Flash from Apple’s iOS devices. The correctness of his arguments need no debate, the event happened, and other solutions were needed. Fortunately, with the rise of HTML5 multimedia facilities, as well as the Canvas or SVG, it would seem that there were legitimate alternatives to Flash and other object-based multimedia technologies.</p>
<p class="indent">However, the HTML5-everywhere reality has been a bit less clean than the storyline. Some things have been quite difficult to do outside of Flash, and the browser support for HTML5 still needs to mature, but Adobe and the Web currently are retreating from object technologies like Flash. For many, these changes signal a clear victory for the ideas of the open Web. However, for us, the future is more uncertain. At the same time, we see old ideas reborn with variations and new names. For example, Google’s Native Client seems to bear more than a passing resemblance to Microsoft’s ActiveX. Further, any idyllic standards-based existence has yet to be found; if anything, compatibility has become more difficult as features are added at breakneck speed, versions change way too often, and standards are extended or boycotted for various reasons. All we can say with certainty is that change will happen, so take the ideas in this chapter as foundations and do the research for any syntax changes.</p>
<h4 class="h4"><a id="page_854"/><a id="ch17lev1sec10"/><strong>Summary</strong></h4>
<p class="indent">Manipulation of media objects from images to positioned content brings Web pages and applications alive. In the past, we have seen some confusion, as these effects often were given their own name, with Dynamic HTML (DHTML) somewhat obfuscating the fact that they were just applications of JavaScript underneath. Today, Web designers are afforded a much richer palette for manipulating multimedia that includes bitmapped image manipulation, vector drawing, browser-based audio and video, and interacting with embedded objects such as plug-ins, ActiveX controls, and Java applets. In general, we see a trend away from third-party components and toward more browser-native facilities, but regardless of this trend, JavaScript has a significant role to play as “glue,” and it is worth studying the APIs and examples in this chapter if you wish to add significant richness to the user’s experience.</p>
</body>
</html>